









    
    
    
    



    










<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Sml Python Small Library Reference - Office for National Statistics</title>
        <link rel="stylesheet" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/css/main.css">
        <link rel="stylesheet" media="print" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/css/print.css">
        <meta name="theme-color" content="#206095"/>
        
            
                
                    <meta name="description" content="/">
                

                <!-- Canonical -->
                <link rel="canonical" href="/">

                
            
        

        
            <!-- Open Graph -->
            <meta property="og:type" content="website">
            <meta property="og:url" content="/">
            <meta property="og:title" content="Sml Python Small Library Reference - Office for National Statistics">
            <meta property="og:image" content="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/opengraph.png">
            <meta property="og:image:type" content="image/png">
            <meta property="og:image:width" content="1200">
            <meta property="og:image:height" content="630">
            <meta property="og:description" content="/">
            <meta property="og:site_name" content="Sml Python Small Library Reference">
            <meta property="og:locale" content="en">

            

            
        

        
            <!-- Favicons -->
            <link rel="icon" type="image/x-icon" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/favicon.ico">
            <link rel="icon" type="image/png" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/favicon-32x32.png" sizes="32x32">
            <link rel="icon" type="image/png" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/favicon-16x16.png" sizes="16x16">
            <link rel="mask-icon" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/safari-pinned-tab.svg" color="#000000">
            <link rel="apple-touch-icon" type="image/png" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/apple-touch-icon.png" sizes="180x180">
            <link rel="manifest" href="https://cdn.ons.gov.uk/sdc/design-system/62.0.0/favicons/manifest.json">
        

        

    </head>
    <body>
        <script>document.body.className = ((document.body.className) ? document.body.className + ' ons-js-enabled' : 'ons-js-enabled');</script>
        
        
            <div class="ons-page">
                <div class="ons-page__content">
                    
                    
                    
                        
    <a class="ons-skip-link" href="#main-content">Skip to main content</a>

                    
                    
                        
    
    
    
    

    
    

    

    <header class="ons-header " role="banner">
        
    
        
        
        
    

    <div class="ons-browser-banner">
        <div class="ons-container">
            <p class="ons-browser-banner__content"><span class="ons-browser-banner__lead">This website no longer supports your browser.</span><span class="ons-browser-banner__cta"> You can <a class="ons-browser-banner__link" href="https://www.ons.gov.uk/help/browsers">upgrade your browser to the latest version</a>.</span></p>
        </div>
    </div>

        
        <div class="ons-header__top">
            <div class="ons-container">
                <div class="ons-header__grid-top ons-grid ons-grid--gutterless ons-grid--flex ons-grid--between ons-grid--vertical-center ons-grid--no-wrap">
                    <div class="ons-grid__col ons-col-auto"><div class="ons-header__org-logo ons-header__org-logo--large">
                            
                                

    

    
    
        <svg class="ons-svg-logo" xmlns="http://www.w3.org/2000/svg" width="197" height="19" viewBox="33 2 552 60" aria-labelledby="ons-logo-en-alt">
            <title id="ons-logo-en-alt">Office for National Statistics logo</title>
            <g class="ons-svg-logo__group ons-svg-logo__group--secondary" fill="#a8bd3a">
                <path d="M0,34.6c.8-1.69,1.39-3,2.32-4.6A38.28,38.28,0,0,1,0,23.4V34.6M5,3S0,3,0,9.25v1A62.12,62.12,0,0,0,4.2,27a43.77,43.77,0,0,1,9.42-10.79C21.69,9.21,31.16,5.13,45.9,3Z"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--primary" fill="#003c57">
                <path d="M53.06,6.42C36.2,8,24.68,12.92,16.43,20.07A41.46,41.46,0,0,0,6.4,32.2C12.87,44.93,28.88,57,46.6,57H47s6.32.21,6.32-6.91V6.36a1.22,1.22,0,0,1-.26.06M9.72,42.67a44.25,44.25,0,0,1-5-7.42A80.59,80.59,0,0,0,0,46.38V56.91L31.06,57c-9.83-3-15.74-7.64-21.34-14.3"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--text" fill="#003c57">
                <path d="M82,47.49c-9.07,0-13.13-7.51-13.13-16.77S72.91,14,82,14s13.1,7.61,13.1,16.77S91.1,47.54,82,47.54m0-30.91c-6.69,0-9.07,7.33-9.07,14.05s2.16,13.9,9.07,13.9,9-7.28,9-13.9-2.34-14-9-14"/>
                <path d="M106.36,23.81V46.88h-3.67V23.81H98.93V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.38,0,.86.05.86.05v2.35h-.43c-2.55,0-4.84,1.64-4.84,5.12v4.09h5.27v2.25Z"/>
                <path d="M121.53,23.81V46.88h-3.67V23.81H114.1V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.38,0,.86.05.86.05v2.35h-.43c-2.55,0-4.84,1.64-4.84,5.12v4.09h5.27v2.25Z"/>
                <path d="M132.85,16.72a2.28,2.28,0,0,1-2.33-2.23v0a2.34,2.34,0,0,1,4.67,0,2.28,2.28,0,0,1-2.3,2.26h0M131,21.56h3.71V46.88H131Z"/>
                <path d="M150.53,47.49c-6,0-10.63-5.16-10.63-13.29S144.52,21,150.66,21a9.76,9.76,0,0,1,6.17,1.74l-1,2.25a7.53,7.53,0,0,0-4.4-1.36c-5.15,0-7.78,4.46-7.78,10.48,0,6.2,3,10.62,7.65,10.62a8,8,0,0,0,4.49-1.37l1,2.45a10.21,10.21,0,0,1-6.3,1.73"/>
                <path d="M162.84,35.75c.48,6,3.76,9,8.9,9a14.66,14.66,0,0,0,6.88-1.55l1.08,2.59a18,18,0,0,1-8.22,1.73c-7.12,0-12.18-4.23-12.18-13.34,0-8.69,4.67-13.2,11-13.2s10.37,3.95,10.37,12.4Zm7.35-12.41c-4.1,0-7.56,3.2-7.52,10.29l14.39-2c0-5.87-2.81-8.32-6.87-8.32"/>
                <path d="M198.57,23.81V46.88H194.9V23.81h-3.76V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.39,0,.87.05.87.05v2.35h-.44c-2.54,0-4.84,1.64-4.84,5.12v4.09h5.28v2.25Z"/>
                <path d="M217.28,47.49c-7.47,0-10.89-5.78-10.89-13.24S209.81,21,217.28,21s10.85,5.82,10.85,13.3-3.37,13.24-10.85,13.24m0-24c-5.53,0-7.13,5.59-7.13,10.81s1.73,10.56,7.13,10.56,7.13-5.35,7.13-10.56-1.6-10.81-7.13-10.81"/>
                <path d="M244.08,23.91c-2.34-.61-5.75-.52-7.35.47v22.5H233V22.69c2.67-1.13,5.36-1.74,10.11-1.74H245Z"/>
                <path d="M277.42,47.13,263.07,25a32.2,32.2,0,0,1-1.85-3.29h-.09s.13,1.88.13,3.85V47.13h-4.71V14.8h5.31l13.61,20.82A28.76,28.76,0,0,1,277.38,39h.08s-.17-1.84-.17-3.77V14.8H282V47.13Z"/>
                <path d="M297.52,47.79c-7.43,0-10.93-3-10.93-7.81,0-6.8,7.12-8.64,15.59-9.39V29.13c0-3.47-2.37-4.51-5.83-4.51a18,18,0,0,0-6.87,1.46L288.23,23a24,24,0,0,1,9.12-1.83c5.61,0,9.93,2.3,9.93,8.78V46a22.71,22.71,0,0,1-9.76,1.83m4.66-14.67c-6.26.67-10.45,1.84-10.45,6.73,0,3.42,2.42,4.88,6.22,4.88a10.09,10.09,0,0,0,4.23-.84Z"/>
                <path d="M322,47.69c-5.31,0-7.34-3.43-7.34-6.86V25.09h-3.55V21.81h3.55V16.12l5.4-1.5v7.19H325v3.28h-5V40.55a3.26,3.26,0,0,0,3,3.52h.5a5.5,5.5,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M331.91,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.44V47.13h-5.44Z"/>
                <path d="M350.88,47.79c-7.73,0-11.57-5.74-11.57-13.3s3.84-13.34,11.57-13.34,11.54,5.78,11.54,13.34-3.8,13.3-11.54,13.3m0-23.17c-4.66,0-6.05,4.89-6.05,9.82s1.47,9.63,6.05,9.63,6.05-4.7,6.05-9.63-1.38-9.82-6.05-9.82"/>
                <path d="M382.52,47.13V29c0-3.24-2.77-4.47-5.88-4.47a12.3,12.3,0,0,0-4.37.76v21.8h-5.39V23a26.81,26.81,0,0,1,10.06-1.83c6.61,0,11,2.25,11,7.8V47.13Z"/>
                <path d="M403.18,47.79c-7.43,0-10.94-3-10.94-7.81,0-6.8,7.13-8.64,15.6-9.39V29.13c0-3.47-2.37-4.51-5.83-4.51a18,18,0,0,0-6.87,1.46L393.89,23A24,24,0,0,1,403,21.15c5.62,0,9.94,2.3,9.94,8.78V46a22.71,22.71,0,0,1-9.76,1.83m4.66-14.67c-6.27.67-10.46,1.84-10.46,6.73,0,3.42,2.43,4.88,6.23,4.88a10.09,10.09,0,0,0,4.23-.84Z"/>
                <polygon points="418.52 47.13 418.52 34.91 418.52 10.25 423.92 10.25 423.92 22.76 423.92 47.13 418.52 47.13"/>
                <path d="M445.39,47.79A19.11,19.11,0,0,1,436.58,46l1.51-4a13.48,13.48,0,0,0,6.22,1.55c3.76,0,6.44-2.21,6.44-5.41,0-7.09-13.44-4.36-13.44-14.42,0-5.13,4.15-9.59,10.72-9.59A15.82,15.82,0,0,1,455.8,16l-1.38,3.52a11.93,11.93,0,0,0-5.66-1.5c-3.5,0-5.79,2.11-5.79,5.12,0,7,13.74,3.94,13.74,14.65,0,5.74-4.71,10-11.32,10"/>
                <path d="M470.41,47.69c-5.31,0-7.34-3.43-7.34-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.92v3.28h-4.92V40.55a3.27,3.27,0,0,0,3,3.52h.48a5.12,5.12,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M487.27,47.79c-7.44,0-10.93-3-10.93-7.81,0-6.8,7.13-8.64,15.6-9.39V29.13c0-3.47-2.38-4.51-5.84-4.51a18,18,0,0,0-6.87,1.46L478,23a23.94,23.94,0,0,1,9.11-1.83c5.62,0,9.94,2.3,9.94,8.78V46a22.71,22.71,0,0,1-9.76,1.83M492,33.16c-6.27.67-10.46,1.84-10.46,6.73,0,3.42,2.42,4.88,6.22,4.88a10,10,0,0,0,4.24-.84Z"/>
                <path d="M511.73,47.69c-5.32,0-7.35-3.43-7.35-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.92v3.28h-4.92V40.55a3.26,3.26,0,0,0,3,3.52h.5a5.5,5.5,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M521.66,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.45V47.13h-5.45Z"/>
                <path d="M536.19,47.79A15.9,15.9,0,0,1,528.54,46L530,42.48a10.53,10.53,0,0,0,5.52,1.5c2.77,0,5-1.78,5-3.94,0-6-11.1-3.2-11.1-11.47,0-3.76,3.37-7.42,8.86-7.42A13.56,13.56,0,0,1,545.34,23l-1.42,3.14a8.47,8.47,0,0,0-4.62-1.45c-2.81,0-4.54,1.69-4.54,3.62,0,5.64,11.32,3.14,11.32,11.6,0,4-3.85,7.9-9.89,7.9"/>
                <path d="M559.83,47.69c-5.31,0-7.35-3.43-7.35-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.93v3.28h-4.93V40.55a3.27,3.27,0,0,0,3,3.52h.48a5.64,5.64,0,0,0,1.47-.23v3.33a7.72,7.72,0,0,1-3,.52"/>
                <path d="M569.77,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.44V47.13h-5.44Z"/>
                <path d="M588.14,47.79c-6.23,0-11-5.08-11-13.35s4.88-13.29,11-13.29A10.51,10.51,0,0,1,594.66,23l-1.21,3a6.87,6.87,0,0,0-4-1.22c-4.4,0-6.69,3.81-6.69,9.49s2.63,9.59,6.61,9.59a6.74,6.74,0,0,0,4-1.28L594.7,46c-1.12.94-3.33,1.84-6.56,1.84"/>
                <path d="M605.1,47.79A15.9,15.9,0,0,1,597.45,46l1.42-3.47A10.54,10.54,0,0,0,604.4,44c2.77,0,5-1.78,5-3.94,0-6-11.1-3.2-11.1-11.47,0-3.76,3.37-7.42,8.85-7.42a13.49,13.49,0,0,1,7.1,1.83l-1.42,3.14a8.42,8.42,0,0,0-4.63-1.45c-2.8,0-4.53,1.69-4.53,3.62,0,5.64,11.32,3.14,11.32,11.6,0,4-3.85,7.9-9.89,7.9"/>
            </g>
        </svg>
    

                            
                        </div>
                        <div class="ons-header__org-logo ons-header__org-logo--small">
                            
                                

    

    
    
        <svg class="ons-svg-logo" xmlns="http://www.w3.org/2000/svg" width="120" height="27" viewBox="0 5 595 116" aria-labelledby="ons-logo-stacked-en-alt">
            <title id="ons-logo-stacked-en-alt">Office for National Statistics logo</title>
            <g class="ons-svg-logo__group ons-svg-logo__group--secondary" fill="#a8bd3a">
                <path d="M0,70.5c1.8-3.7,3.6-7.2,5.6-10.7A127.94,127.94,0,0,1,0,42.6V70.5M10.9,0S0,0,0,13.5v7.2A128.06,128.06,0,0,0,7.9,56.2a114.75,114.75,0,0,1,22.3-26C47.8,15.1,71.5,4.7,103.7.1Z"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--primary" fill="#003c57">
                <path d="M115.9,7.3c-36.8,3.5-62,14-80,29.4a108.15,108.15,0,0,0-23.6,29c14.1,27.4,41.1,47.6,86,50.5h4.4s13.8.5,13.8-14.9V7.2l-.6.1M21.2,85.4a92.68,92.68,0,0,1-11-16A173,173,0,0,0,0,93.4v22.7l73.6.1c-22.9-5.5-40.1-16.4-52.4-30.8"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--text" fill="#003c57">
                <path d="M161,51.9c-11.3,0-16.3-9.3-16.3-20.8s5-20.8,16.3-20.8,16.3,9.5,16.3,20.8c-.1,11.5-5.1,20.8-16.3,20.8m0-38.3c-8.3,0-11.3,9.1-11.3,17.4s2.7,17.3,11.3,17.3,11.2-9.1,11.2-17.3S169.3,13.6,161,13.6m30.2,8.9V51.2h-4.5V22.6H182V19.8h4.7V15.2c0-5.7,3.4-9.9,10-9.9a8,8,0,0,1,1.1.1V8.3h-.5c-3.2,0-6,2.1-6,6.4v5.1h6.6v2.8l-6.7-.1Zm18.9,0V51.2h-4.5V22.6h-4.7V19.8h4.7V15.2c0-5.7,3.4-9.9,10-9.9a8,8,0,0,1,1.1.1V8.3h-.5c-3.2,0-6,2.1-6,6.4v5.1h6.6v2.8l-6.7-.1Zm14-8.8a2.82,2.82,0,0,1-2.9-2.8,2.9,2.9,0,0,1,5.8,0,2.76,2.76,0,0,1-2.9,2.8m-2.3,6h4.6V51.2h-4.6Zm24.3,32.2c-7.4,0-13.2-6.4-13.2-16.5,0-10.3,5.8-16.5,13.4-16.5a12.36,12.36,0,0,1,7.7,2.2l-1.2,2.8a8.92,8.92,0,0,0-5.5-1.7c-6.4,0-9.7,5.5-9.7,13,0,7.7,3.7,13.2,9.5,13.2a9.8,9.8,0,0,0,5.6-1.7l1.2,3c-1.3,1.2-4,2.2-7.8,2.2m15.3-14.6c.6,7.4,4.7,11.1,11.1,11.1a18.36,18.36,0,0,0,8.5-1.9l1.3,3.2a22.58,22.58,0,0,1-10.2,2.1c-8.8,0-15.1-5.3-15.1-16.6,0-10.8,5.8-16.4,13.7-16.4s12.9,4.9,12.9,15.4l-22.2,3.1ZM270.5,22c-5.1,0-9.4,4-9.3,12.8l17.9-2.5C279,25,275.5,22,270.5,22m42.2.5V51.2h-4.5V22.6h-4.7V19.8h4.7V15.2c0-5.7,3.4-9.9,10-9.9a8,8,0,0,1,1.1.1V8.3h-.5c-3.2,0-6,2.1-6,6.4v5.1h6.6v2.8Zm23.2,29.4c-9.3,0-13.5-7.2-13.5-16.5s4.2-16.5,13.5-16.5,13.5,7.2,13.5,16.5-4.2,16.5-13.5,16.5m0-29.8c-6.9,0-8.8,7-8.8,13.4s2.1,13.1,8.8,13.1c6.9,0,8.9-6.6,8.9-13.1s-2-13.4-8.9-13.4m33.3.6c-2.9-.8-7.1-.6-9.1.6V51.2h-4.6V21.1c3.3-1.4,6.6-2.2,12.5-2.2h2.4c0,.1-1.2,3.8-1.2,3.8ZM171.3,114.8,153.5,87.3c-1.3-2.1-2.3-4.1-2.3-4.1h-.1s.2,2.3.2,4.8v26.8h-5.8V74.7h6.6L169,100.5a46.13,46.13,0,0,1,2.4,4.1h.1s-.2-2.3-.2-4.7V74.6h5.9v40.1l-5.9.1Zm25,.8c-9.2,0-13.6-3.7-13.6-9.7,0-8.5,8.8-10.7,19.4-11.7V92.4c0-4.3-2.9-5.6-7.2-5.6a22.34,22.34,0,0,0-8.5,1.8l-1.6-3.8a30.2,30.2,0,0,1,11.3-2.3c7,0,12.3,2.9,12.3,10.9v19.9c-2.7,1.4-6.9,2.3-12.1,2.3m5.8-18.2c-7.8.8-13,2.3-13,8.3,0,4.2,3,6.1,7.7,6.1a12.33,12.33,0,0,0,5.3-1.1Zm24.5,18.1c-6.6,0-9.1-4.3-9.1-8.5V87.5h-4.4V83.4h4.4v-7l6.7-1.9v8.9h6.1v4.1h-6.1v19.2c0,2.5,1.4,4.4,4.3,4.4a5.66,5.66,0,0,0,1.8-.3v4.1a11.47,11.47,0,0,1-3.7.6M239,77.9a3.52,3.52,0,1,1,3.9-3.5,3.71,3.71,0,0,1-3.9,3.5m-3.4,5.5h6.8v31.4h-6.8Zm26.9,32.2c-9.6,0-14.4-7.1-14.4-16.5s4.8-16.6,14.4-16.6,14.3,7.2,14.3,16.6-4.7,16.5-14.3,16.5m0-28.7c-5.8,0-7.5,6.1-7.5,12.2s1.8,11.9,7.5,11.9,7.5-5.8,7.5-11.9-1.7-12.2-7.5-12.2m39.3,27.9V92.3c0-4-3.4-5.5-7.3-5.5a16,16,0,0,0-5.4.9v27.1h-6.7v-30a32.8,32.8,0,0,1,12.5-2.3c8.2,0,13.7,2.8,13.7,9.7v22.6Zm25.7.8c-9.2,0-13.6-3.7-13.6-9.7,0-8.5,8.9-10.7,19.4-11.7V92.4c0-4.3-2.9-5.6-7.2-5.6a22.34,22.34,0,0,0-8.5,1.8L316,84.8a30.2,30.2,0,0,1,11.3-2.3c7,0,12.3,2.9,12.3,10.9v19.9c-2.7,1.4-6.9,2.3-12.1,2.3m5.8-18.2c-7.8.8-13,2.3-13,8.3,0,4.2,3,6.1,7.7,6.1a12.33,12.33,0,0,0,5.3-1.1Zm13.2,17.4V69h6.7v45.8Zm38.6.8a23.94,23.94,0,0,1-10.9-2.3l1.9-4.9a17,17,0,0,0,7.7,1.9c4.7,0,8-2.7,8-6.7,0-8.8-16.7-5.4-16.7-17.9,0-6.4,5.2-11.9,13.3-11.9a20.22,20.22,0,0,1,9.7,2.3l-1.7,4.4a14.57,14.57,0,0,0-7-1.9c-4.3,0-7.2,2.6-7.2,6.4,0,8.6,17.1,4.9,17.1,18.2-.1,7.1-6,12.4-14.2,12.4m31.1-.1c-6.6,0-9.1-4.3-9.1-8.5V87.5h-4.4V83.4h4.4v-7l6.7-1.9v8.9h6.1v4.1h-6.1v19.2a4.07,4.07,0,0,0,4.3,4.4,5.66,5.66,0,0,0,1.8-.3v4.1a12.06,12.06,0,0,1-3.7.6m20.9.1c-9.2,0-13.6-3.7-13.6-9.7,0-8.5,8.9-10.7,19.4-11.7V92.4c0-4.3-2.9-5.6-7.2-5.6a22.34,22.34,0,0,0-8.5,1.8l-1.6-3.8a30.2,30.2,0,0,1,11.3-2.3c7,0,12.3,2.9,12.3,10.9v19.9c-2.6,1.4-6.9,2.3-12.1,2.3m5.8-18.2c-7.8.8-13,2.3-13,8.3,0,4.2,3,6.1,7.7,6.1a12.33,12.33,0,0,0,5.3-1.1Zm24.6,18.1c-6.6,0-9.1-4.3-9.1-8.5V87.5H454V83.4h4.4v-7l6.7-1.9v8.9h6.1v4.1h-6.1v19.2a4.07,4.07,0,0,0,4.3,4.4,5.66,5.66,0,0,0,1.8-.3v4.1a12.69,12.69,0,0,1-3.7.6m12.3-37.6a3.52,3.52,0,1,1,3.9-3.5,3.65,3.65,0,0,1-3.9,3.5m-3.4,5.5h6.8v31.4h-6.8Zm21.4,32.2a19.46,19.46,0,0,1-9.5-2.3l1.8-4.3a13.21,13.21,0,0,0,6.9,1.9c3.4,0,6.2-2.2,6.2-4.9,0-7.5-13.8-4-13.8-14.2,0-4.7,4.2-9.2,11-9.2a16.21,16.21,0,0,1,8.8,2.3l-1.8,3.9a10.31,10.31,0,0,0-5.7-1.8c-3.5,0-5.6,2.1-5.6,4.5,0,7,14,3.9,14,14.4,0,4.9-4.7,9.7-12.3,9.7m29.4-.1c-6.6,0-9.1-4.3-9.1-8.5V87.5h-4.4V83.4h4.4v-7l6.7-1.9v8.9h6.1v4.1h-6.1v19.2c0,2.5,1.4,4.4,4.3,4.4a5.66,5.66,0,0,0,1.8-.3v4.1a12.06,12.06,0,0,1-3.7.6m12.3-37.6a3.52,3.52,0,1,1,3.9-3.5c.1,2-1.7,3.5-3.9,3.5m-3.3,5.5H543v31.4h-6.8Zm26.2,32.2c-7.7,0-13.6-6.3-13.6-16.6s6.1-16.5,13.7-16.5c3.9,0,6.6,1.1,8,2.3L569,88.6a8.61,8.61,0,0,0-4.9-1.5c-5.5,0-8.3,4.7-8.3,11.8s3.3,11.9,8.2,11.9a8.39,8.39,0,0,0,4.9-1.6l1.7,4.1c-1.5,1.2-4.2,2.3-8.2,2.3m20.6,0a19.46,19.46,0,0,1-9.5-2.3l1.8-4.3a13.21,13.21,0,0,0,6.9,1.9c3.4,0,6.2-2.2,6.2-4.9,0-7.5-13.8-4-13.8-14.2,0-4.7,4.2-9.2,11-9.2a16.85,16.85,0,0,1,8.9,2.3l-1.8,3.9A10.31,10.31,0,0,0,587,87c-3.5,0-5.6,2.1-5.6,4.5,0,7,14,3.9,14,14.4-.1,4.9-4.9,9.7-12.4,9.7"/>
            </g>
        </svg>
    

                            
                        </div>
                        
                    </div>
                    
                </div>
            </div>
            
        </div>
        <div class="ons-header__main">
            <div class="ons-container">
                <div class="ons-grid ons-grid--gutterless ons-grid--flex ons-grid--between ons-grid--vertical-center ons-grid--no-wrap">
                    <div class="ons-grid__col ons-col-auto ons-u-flex-shrink">
                        
                            
                                <div class="ons-header__title">Sml Python Small Library Reference</div>
                            
                        
                        
                    </div>

                    
                    
                </div>
            </div>
        </div>
        
    </header>

                    
                    
                        <div class="ons-page__container ons-container">
                            
                                
                            
                            <div class="ons-grid">
                                <div class="ons-grid__col ons-col-12@m ">
                                    <main id="main-content" class="ons-page__main ">
                                        
        <section class="p-md-5 section-content">
    <article>
        <p><div class="doc doc-object doc-module">


<a id="sml_small.date_adjustment"></a>
  <div class="doc doc-contents first">
  
      <p>For Copyright information, please see LICENCE.</p>

  

  <div class="doc doc-children">









<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.average_weekly_subfunction">
<code class="highlight language-python"><span class="n">average_weekly_subfunction</span><span class="p">(</span><span class="n">df_stage_five</span><span class="p">,</span> <span class="n">average_weekly_questions_list</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Applies the average weekly method to the input data.</p>
<p>:param  df_stage_five: The dataframe containing the data as processed to this point.
:param  average_weekly_questions_list: The names of the columns in the input dataframe to be processed by the
        average weekly method.
:param  da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame; If the average weekly questions list parameter is
        not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe; If
        columns referenced in average_weekly_questions_list parameter cannot be found in the input dataframe.</p>
<p>:return: A dataframe holding data with the average weekly method applied.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1187</span>
<span class="normal">1188</span>
<span class="normal">1189</span>
<span class="normal">1190</span>
<span class="normal">1191</span>
<span class="normal">1192</span>
<span class="normal">1193</span>
<span class="normal">1194</span>
<span class="normal">1195</span>
<span class="normal">1196</span>
<span class="normal">1197</span>
<span class="normal">1198</span>
<span class="normal">1199</span>
<span class="normal">1200</span>
<span class="normal">1201</span>
<span class="normal">1202</span>
<span class="normal">1203</span>
<span class="normal">1204</span>
<span class="normal">1205</span>
<span class="normal">1206</span>
<span class="normal">1207</span>
<span class="normal">1208</span>
<span class="normal">1209</span>
<span class="normal">1210</span>
<span class="normal">1211</span>
<span class="normal">1212</span>
<span class="normal">1213</span>
<span class="normal">1214</span>
<span class="normal">1215</span>
<span class="normal">1216</span>
<span class="normal">1217</span>
<span class="normal">1218</span>
<span class="normal">1219</span>
<span class="normal">1220</span>
<span class="normal">1221</span>
<span class="normal">1222</span>
<span class="normal">1223</span>
<span class="normal">1224</span>
<span class="normal">1225</span>
<span class="normal">1226</span>
<span class="normal">1227</span>
<span class="normal">1228</span>
<span class="normal">1229</span>
<span class="normal">1230</span>
<span class="normal">1231</span>
<span class="normal">1232</span>
<span class="normal">1233</span>
<span class="normal">1234</span>
<span class="normal">1235</span>
<span class="normal">1236</span>
<span class="normal">1237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">average_weekly_subfunction</span><span class="p">(</span>
    <span class="n">df_stage_five</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">average_weekly_questions_list</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the average weekly method to the input data.</span>

<span class="sd">    :param  df_stage_five: The dataframe containing the data as processed to this point.</span>
<span class="sd">    :param  average_weekly_questions_list: The names of the columns in the input dataframe to be processed by the</span>
<span class="sd">            average weekly method.</span>
<span class="sd">    :param  da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame; If the average weekly questions list parameter is</span>
<span class="sd">            not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe; If</span>
<span class="sd">            columns referenced in average_weekly_questions_list parameter cannot be found in the input dataframe.</span>

<span class="sd">    :return: A dataframe holding data with the average weekly method applied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Basic validation</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span>
        <span class="n">input_dataframe</span><span class="o">=</span><span class="n">df_stage_five</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="o">=</span><span class="n">average_weekly_questions_list</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns in input_dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="n">average_weekly_questions_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;df_stage_five&quot;</span><span class="p">,</span> <span class="n">df_stage_five</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="c1"># Apply average weekly to average_weekly_questions_list, if any.</span>

    <span class="k">def</span> <span class="nf">set_average_weekly</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">base_col</span> <span class="ow">in</span> <span class="n">average_weekly_questions_list</span><span class="p">:</span>
            <span class="n">source_col</span> <span class="o">=</span> <span class="s2">&quot;date_adjusted_&quot;</span> <span class="o">+</span> <span class="n">base_col</span>
            <span class="n">new_col</span> <span class="o">=</span> <span class="s2">&quot;average_weekly_&quot;</span> <span class="o">+</span> <span class="n">base_col</span>
            <span class="n">row</span><span class="p">[</span><span class="n">new_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">source_col</span><span class="p">])</span> <span class="o">/</span> <span class="n">row</span><span class="p">[</span>
                <span class="s2">&quot;number_of_days_in_actual_returned_period&quot;</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">df_stage_six</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span><span class="n">df_stage_five</span><span class="p">,</span> <span class="n">set_average_weekly</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_six</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.date_adjustment">
<code class="highlight language-python"><span class="n">date_adjustment</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">contributor_returned_start_date_col</span><span class="p">,</span> <span class="n">contributor_returned_end_date_col</span><span class="p">,</span> <span class="n">expected_start_date_col</span><span class="p">,</span> <span class="n">expected_end_date_col</span><span class="p">,</span> <span class="n">domain_col</span><span class="p">,</span> <span class="n">short_period_parameter_col</span><span class="p">,</span> <span class="n">long_period_parameter_col</span><span class="p">,</span> <span class="n">equal_weighted_col</span><span class="p">,</span> <span class="n">set_to_mid_point_col</span><span class="p">,</span> <span class="n">use_calendar_days_col</span><span class="p">,</span> <span class="n">average_weekly_col</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_weights_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">,</span> <span class="n">trading_period_start_col</span><span class="p">,</span> <span class="n">trading_period_end_col</span><span class="p">,</span> <span class="n">ignore_multi_aw_param_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <pre><code>**Description**:

The controlling function validates that validates input and steps the data through
the sub-functions in the following order:

1. generate_average_weekly_questions.
2. missing_value_subfunction.
3. primary_wrangler_subfunction.
4. midpoint_subfunction.
5. secondary_wrangler_subfunction.
6. date_adjustment_subfunction.
7. average_weekly_subfunction.

All calculations are done on a row by row basis. Full documentation can be found in
the README.md file in the docs directory.
</code></pre>
<hr />
<pre><code>**Parameters**

:param  input_dataframe: The dataframe containing the data to be processed plus processing options.
:param  trading_weights: The trading day weight reference data required for processing.
:param  target_columns: The names of the columns in input_dataframe to be date_adjusted.
:param  contributor_returned_start_date_col: Name of the column holding the contributors
returned period start date.
:param  contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.
:param  expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.
:param  expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.
:param  domain_col: Name of the column holding the Domain in input_dataframe.
:param  short_period_parameter_col: Name of the column holding the "short period parameter" in input_dataframe.
:param  long_period_parameter_col: Name of the column holding the "long period parameter" in input_dataframe.
:param  set_to_mid_point_col: Name of the column holding the "Set to mid-point" option in input_dataframe.
:param  use_calendar_days_col: Name of the column holding the "use calendar days" option in input_dataframe.
:param  equal_weighted_col: Name of the column holding the "Set to equal weighted" option in input_dataframe.
:param  average_weekly_col: Name of the column holding the "average_weekly"
in input_dataframe.
:param  da_error_flag_col: Name of the column that the user wishes the error flag column to
be called in the output.
:param  trading_date_col: Name of the column holding the dates in trading_weights.
:param  trading_weights_col: Name of the column holding the weights in the
trading_weights DataFrame.
:param  trading_domain_col: Name of the column holding the domain in the
trading_weights DataFrame.
:param  trading_period_start_col: Name of the column holding the trading period start
date in the trading_weightsDataFrame.
:param  trading_period_end_col: Name of the column holding the trading period end date in the trading_weights
        DataFrame.
:param  ignore_multi_aw_param_error: Used in testing only. Leave blank so it defaults to False.

:raises TypeError: If the input dataframe is not a DataFrame.
:raises TypeError: If the trading weights reference data is not a DataFrame.
:raises TypeError: If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the
        trading weights dataframe as appropriate.
:raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.
:raises ValueError: If mixed values found in the input dataframe for equal_weighted_col, set_to_mid_point_col or
        average_weekly_col.

:returns: The input data with the method output appended as extra columns as necessary
</code></pre>
<hr />
<pre><code>**Error Flags**

If a row of data is not able to be processed, an error flag will be raised to
indicate the issue with the data.
The error flags are as follows:
    * E00: Average Weekly parameter is invalid.
    * E01: The value to be date adjusted is missing from one of the target columns.
    * E02: The contributor returned end date is earlier than the contributor returned
            start date.
    * E03: A required record for calculating weight m is missing from the trading
            weights table.
    * E04: A required trading weight for calculating weight m is null or blank.
    * E05: A required trading weight for calculating weight m has a negative value.
    * E06: A required record for calculating weight n is missing from or duplicated in
            the trading  weights table.
    * E07: A required trading weight for calculating weight n is null or blank.
    * E08: A required trading weight for calculating weight n has a negative value.
    * E09: Contributors return does not cover any of expected period.
    * E10: The sum of trading day weights over contributors returned period is zero.
    * E11: The sum of trading day weights over contributors returned period is zero.
    * E12: A required record for calculating midpoint date is missing from the
            trading weights table.
    * E13: A required record for setting APS and APE by midpoint is missing from or
            duplicated in the trading  weights table.
    * E14: Expected period start date is missing or an invalid date.
    * E15: Expected period end date is missing or an invalid date.

    ** NOTE: **
    These are NOT exceptions and do not cause the method to fail. Once an error flag
    has been placed on a row of data, no further processing is done to that row,
    preserving the data in the state it was when the flag was raised.

    If at any point in processing an error flag is set on all rows, processing will
    stop after that sub-function and the dataframe will be returned as it is at that
    point to allow the user to 'debug' their data.
</code></pre>
<hr />
<pre><code>**Warning Flags**

If a row of data is able to be processed, but requires the user to be notified of a
potential issue, a warning flag is raised for that row. The following warning flags
are applied in the given circumstances:

        *  S: The contributors returned period is less than the threshold supplied
              in the short period parameter.
        *  L: The contributors returned period is greater than the threshold supplied
              in the long period parameter.
        * SL: The supplied short period parameter is greater than or equal to the
              supplied long period parameter.

    **NOTE:**
    A warning flag does not stop the method running, and the row will continue to be
    processed as normal.
</code></pre>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">date_adjustment</span><span class="p">(</span>
    <span class="n">input_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">trading_weights</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">contributor_returned_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contributor_returned_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">short_period_parameter_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">long_period_parameter_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">equal_weighted_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">set_to_mid_point_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_calendar_days_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">average_weekly_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_weights_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_period_start_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_period_end_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">ignore_multi_aw_param_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        **Description**:</span>

<span class="sd">        The controlling function validates that validates input and steps the data through</span>
<span class="sd">        the sub-functions in the following order:</span>

<span class="sd">        1. generate_average_weekly_questions.</span>
<span class="sd">        2. missing_value_subfunction.</span>
<span class="sd">        3. primary_wrangler_subfunction.</span>
<span class="sd">        4. midpoint_subfunction.</span>
<span class="sd">        5. secondary_wrangler_subfunction.</span>
<span class="sd">        6. date_adjustment_subfunction.</span>
<span class="sd">        7. average_weekly_subfunction.</span>

<span class="sd">        All calculations are done on a row by row basis. Full documentation can be found in</span>
<span class="sd">        the README.md file in the docs directory.</span>
<span class="sd">    ----</span>
<span class="sd">        **Parameters**</span>

<span class="sd">        :param  input_dataframe: The dataframe containing the data to be processed plus processing options.</span>
<span class="sd">        :param  trading_weights: The trading day weight reference data required for processing.</span>
<span class="sd">        :param  target_columns: The names of the columns in input_dataframe to be date_adjusted.</span>
<span class="sd">        :param  contributor_returned_start_date_col: Name of the column holding the contributors</span>
<span class="sd">        returned period start date.</span>
<span class="sd">        :param  contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.</span>
<span class="sd">        :param  expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.</span>
<span class="sd">        :param  expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.</span>
<span class="sd">        :param  domain_col: Name of the column holding the Domain in input_dataframe.</span>
<span class="sd">        :param  short_period_parameter_col: Name of the column holding the &quot;short period parameter&quot; in input_dataframe.</span>
<span class="sd">        :param  long_period_parameter_col: Name of the column holding the &quot;long period parameter&quot; in input_dataframe.</span>
<span class="sd">        :param  set_to_mid_point_col: Name of the column holding the &quot;Set to mid-point&quot; option in input_dataframe.</span>
<span class="sd">        :param  use_calendar_days_col: Name of the column holding the &quot;use calendar days&quot; option in input_dataframe.</span>
<span class="sd">        :param  equal_weighted_col: Name of the column holding the &quot;Set to equal weighted&quot; option in input_dataframe.</span>
<span class="sd">        :param  average_weekly_col: Name of the column holding the &quot;average_weekly&quot;</span>
<span class="sd">        in input_dataframe.</span>
<span class="sd">        :param  da_error_flag_col: Name of the column that the user wishes the error flag column to</span>
<span class="sd">        be called in the output.</span>
<span class="sd">        :param  trading_date_col: Name of the column holding the dates in trading_weights.</span>
<span class="sd">        :param  trading_weights_col: Name of the column holding the weights in the</span>
<span class="sd">        trading_weights DataFrame.</span>
<span class="sd">        :param  trading_domain_col: Name of the column holding the domain in the</span>
<span class="sd">        trading_weights DataFrame.</span>
<span class="sd">        :param  trading_period_start_col: Name of the column holding the trading period start</span>
<span class="sd">        date in the trading_weightsDataFrame.</span>
<span class="sd">        :param  trading_period_end_col: Name of the column holding the trading period end date in the trading_weights</span>
<span class="sd">                DataFrame.</span>
<span class="sd">        :param  ignore_multi_aw_param_error: Used in testing only. Leave blank so it defaults to False.</span>

<span class="sd">        :raises TypeError: If the input dataframe is not a DataFrame.</span>
<span class="sd">        :raises TypeError: If the trading weights reference data is not a DataFrame.</span>
<span class="sd">        :raises TypeError: If the target columns parameter is not a List.</span>
<span class="sd">        :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the</span>
<span class="sd">                trading weights dataframe as appropriate.</span>
<span class="sd">        :raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</span>
<span class="sd">        :raises ValueError: If mixed values found in the input dataframe for equal_weighted_col, set_to_mid_point_col or</span>
<span class="sd">                average_weekly_col.</span>

<span class="sd">        :returns: The input data with the method output appended as extra columns as necessary</span>

<span class="sd">    ----</span>
<span class="sd">        **Error Flags**</span>

<span class="sd">        If a row of data is not able to be processed, an error flag will be raised to</span>
<span class="sd">        indicate the issue with the data.</span>
<span class="sd">        The error flags are as follows:</span>
<span class="sd">            * E00: Average Weekly parameter is invalid.</span>
<span class="sd">            * E01: The value to be date adjusted is missing from one of the target columns.</span>
<span class="sd">            * E02: The contributor returned end date is earlier than the contributor returned</span>
<span class="sd">                    start date.</span>
<span class="sd">            * E03: A required record for calculating weight m is missing from the trading</span>
<span class="sd">                    weights table.</span>
<span class="sd">            * E04: A required trading weight for calculating weight m is null or blank.</span>
<span class="sd">            * E05: A required trading weight for calculating weight m has a negative value.</span>
<span class="sd">            * E06: A required record for calculating weight n is missing from or duplicated in</span>
<span class="sd">                    the trading  weights table.</span>
<span class="sd">            * E07: A required trading weight for calculating weight n is null or blank.</span>
<span class="sd">            * E08: A required trading weight for calculating weight n has a negative value.</span>
<span class="sd">            * E09: Contributors return does not cover any of expected period.</span>
<span class="sd">            * E10: The sum of trading day weights over contributors returned period is zero.</span>
<span class="sd">            * E11: The sum of trading day weights over contributors returned period is zero.</span>
<span class="sd">            * E12: A required record for calculating midpoint date is missing from the</span>
<span class="sd">                    trading weights table.</span>
<span class="sd">            * E13: A required record for setting APS and APE by midpoint is missing from or</span>
<span class="sd">                    duplicated in the trading  weights table.</span>
<span class="sd">            * E14: Expected period start date is missing or an invalid date.</span>
<span class="sd">            * E15: Expected period end date is missing or an invalid date.</span>

<span class="sd">            ** NOTE: **</span>
<span class="sd">            These are NOT exceptions and do not cause the method to fail. Once an error flag</span>
<span class="sd">            has been placed on a row of data, no further processing is done to that row,</span>
<span class="sd">            preserving the data in the state it was when the flag was raised.</span>

<span class="sd">            If at any point in processing an error flag is set on all rows, processing will</span>
<span class="sd">            stop after that sub-function and the dataframe will be returned as it is at that</span>
<span class="sd">            point to allow the user to &#39;debug&#39; their data.</span>

<span class="sd">    ----</span>
<span class="sd">        **Warning Flags**</span>

<span class="sd">        If a row of data is able to be processed, but requires the user to be notified of a</span>
<span class="sd">        potential issue, a warning flag is raised for that row. The following warning flags</span>
<span class="sd">        are applied in the given circumstances:</span>

<span class="sd">                *  S: The contributors returned period is less than the threshold supplied</span>
<span class="sd">                      in the short period parameter.</span>
<span class="sd">                *  L: The contributors returned period is greater than the threshold supplied</span>
<span class="sd">                      in the long period parameter.</span>
<span class="sd">                * SL: The supplied short period parameter is greater than or equal to the</span>
<span class="sd">                      supplied long period parameter.</span>

<span class="sd">            **NOTE:**</span>
<span class="sd">            A warning flag does not stop the method running, and the row will continue to be</span>
<span class="sd">            processed as normal.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Initialise dtypes for input columns</span>
    <span class="n">dtype_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">use_calendar_days_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">short_period_parameter_col</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
        <span class="n">long_period_parameter_col</span><span class="p">:</span> <span class="s2">&quot;int64&quot;</span><span class="p">,</span>
        <span class="n">average_weekly_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">trading_date_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">trading_weights_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">trading_domain_col</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
        <span class="n">trading_period_start_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="n">trading_period_end_col</span><span class="p">:</span> <span class="s2">&quot;datetime64[ns]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;domain_col_list&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">domain_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># Basic validation</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span>
        <span class="n">input_dataframe</span><span class="o">=</span><span class="n">input_dataframe</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="o">=</span><span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Check df dtypes and change where necessary</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="n">input_dataframe</span> <span class="o">=</span> <span class="n">_set_dtypes</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">,</span> <span class="n">dtype_dict</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>

    <span class="c1"># Validate required columns in input_dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">,</span>
        <span class="n">use_calendar_days_col</span><span class="p">,</span>
        <span class="n">short_period_parameter_col</span><span class="p">,</span>
        <span class="n">long_period_parameter_col</span><span class="p">,</span>
        <span class="n">average_weekly_col</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
        <span class="n">required_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;input_dataframe&quot;</span><span class="p">,</span> <span class="n">input_dataframe</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns are in trading_weights dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">trading_weights_col</span><span class="p">,</span>
        <span class="n">trading_date_col</span><span class="p">,</span>
        <span class="n">trading_domain_col</span><span class="p">,</span>
        <span class="n">trading_period_start_col</span><span class="p">,</span>
        <span class="n">trading_period_end_col</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;trading_weights&quot;</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="c1"># Ensure only one average_weekly_param value present</span>
    <span class="n">check_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">[</span><span class="n">average_weekly_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_multi_aw_param_error</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Initiate fast fail with AW error flag in error flag column</span>
            <span class="n">df_aw_param_error</span> <span class="o">=</span> <span class="n">input_dataframe</span>
            <span class="n">df_aw_param_error</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;E00&quot;</span>
            <span class="k">return</span> <span class="n">df_aw_param_error</span>

    <span class="c1"># Ensure only one set_to_mid_point_col value present</span>
    <span class="n">check_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">[</span><span class="n">set_to_mid_point_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_multi_aw_param_error</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;the use mid-point method parameter from </span><span class="si">{</span><span class="n">set_to_mid_point_col</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;has more than one unique value set in the input dataframe.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Ensure only one equal_weighted_col value present</span>
    <span class="n">check_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">[</span><span class="n">equal_weighted_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_multi_aw_param_error</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">check_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;the use equal weights parameter from </span><span class="si">{</span><span class="n">equal_weighted_col</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;has more than one unique value set in the input dataframe.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Check cols for reserved names (ones that method adds later) to prevent overwrite.</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">reserved</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;midpoint&quot;</span><span class="p">,</span>
        <span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">,</span>
        <span class="s2">&quot;date_change_in_return_period_flag&quot;</span><span class="p">,</span>
        <span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span>
        <span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">reserved</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Reserved column name of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> found in input dataframe column names.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Initialise &#39;average_weekly_questions_list&#39; to hold list of questions that will</span>
    <span class="c1"># use average weekly functionality</span>
    <span class="n">average_weekly_param</span> <span class="o">=</span> <span class="n">input_dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">average_weekly_col</span><span class="p">]</span>
    <span class="n">average_weekly_questions_list</span> <span class="o">=</span> <span class="n">generate_average_weekly_questions</span><span class="p">(</span>
        <span class="n">average_weekly_param</span><span class="p">,</span> <span class="n">target_columns</span>
    <span class="p">)</span>
    <span class="c1"># indirectly validate contents of average_weekly parameter</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">average_weekly_questions_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="c1"># Initiate fast fail with AW error flag in error flag column</span>
        <span class="n">df_aw_param_error</span> <span class="o">=</span> <span class="n">input_dataframe</span>
        <span class="n">df_aw_param_error</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;E00&quot;</span>
        <span class="k">return</span> <span class="n">df_aw_param_error</span>

    <span class="c1"># Send dataframe through missing value subfunction</span>
    <span class="n">df_stage_one</span> <span class="o">=</span> <span class="n">missing_value_subfunction</span><span class="p">(</span>
        <span class="n">input_dataframe</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="c1"># Check df_stage_one dtypes and change where necessary</span>
    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="n">df_stage_one</span> <span class="o">=</span> <span class="n">_set_dtypes</span><span class="p">(</span><span class="n">df_stage_one</span><span class="p">,</span> <span class="n">dtype_dict</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>

    <span class="c1"># Check trading_weights dtypes and change where necessary</span>
    <span class="n">trading_weights</span> <span class="o">=</span> <span class="n">_set_dtypes</span><span class="p">(</span><span class="n">trading_weights</span><span class="p">,</span> <span class="n">dtype_dict</span><span class="p">)</span>

    <span class="c1"># If all rows error flagged, output dataframe as is.</span>
    <span class="k">if</span> <span class="n">df_stage_one</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df_stage_one</span>

    <span class="n">df_stage_two</span> <span class="o">=</span> <span class="n">primary_wrangler_subfunction</span><span class="p">(</span>
        <span class="n">df_stage_one</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="p">,</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
        <span class="n">trading_domain_col</span><span class="p">,</span>
        <span class="n">trading_date_col</span><span class="p">,</span>
        <span class="n">trading_weights_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If all rows error flagged, output dataframe as is.</span>
    <span class="k">if</span> <span class="n">df_stage_two</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df_stage_two</span>

    <span class="c1"># Send dataframe through midpoint method</span>
    <span class="n">df_stage_three</span> <span class="o">=</span> <span class="n">midpoint_subfunction</span><span class="p">(</span>
        <span class="n">df_stage_two</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">use_calendar_days_col</span><span class="p">,</span>
        <span class="n">trading_date_col</span><span class="p">,</span>
        <span class="n">trading_period_start_col</span><span class="p">,</span>
        <span class="n">trading_period_end_col</span><span class="p">,</span>
        <span class="n">trading_weights_col</span><span class="p">,</span>
        <span class="n">trading_domain_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If all rows error flagged, output dataframe as is.</span>
    <span class="k">if</span> <span class="n">df_stage_three</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df_stage_three</span>

    <span class="c1"># Send dataframe through secondary wrangler</span>
    <span class="n">df_stage_four</span> <span class="o">=</span> <span class="n">secondary_wrangler_subfunction</span><span class="p">(</span>
        <span class="n">df_stage_three</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="p">,</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">,</span>
        <span class="n">short_period_parameter_col</span><span class="p">,</span>
        <span class="n">long_period_parameter_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
        <span class="n">trading_date_col</span><span class="p">,</span>
        <span class="n">trading_domain_col</span><span class="p">,</span>
        <span class="n">trading_weights_col</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># If all rows error flagged, output dataframe as is.</span>
    <span class="k">if</span> <span class="n">df_stage_four</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df_stage_four</span>

    <span class="c1"># Send dataframe through date adjustment method.</span>
    <span class="n">df_stage_five</span> <span class="o">=</span> <span class="n">date_adjustment_subfunction</span><span class="p">(</span>
        <span class="n">df_stage_four</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="c1"># If all rows error flagged, output dataframe as is.</span>
    <span class="k">if</span> <span class="n">df_stage_five</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">df_stage_five</span>

    <span class="c1"># Send dataframe through average weekly method.</span>
    <span class="n">df_stage_six</span> <span class="o">=</span> <span class="n">average_weekly_subfunction</span><span class="p">(</span>
        <span class="n">df_stage_five</span><span class="p">,</span> <span class="n">average_weekly_questions_list</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="n">output_dataframe</span> <span class="o">=</span> <span class="n">df_stage_six</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">output_dataframe</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.date_adjustment_subfunction">
<code class="highlight language-python"><span class="n">date_adjustment_subfunction</span><span class="p">(</span><span class="n">df_stage_four</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Prepares the data for further processing by the date adjustment and average weekly methods as required.</p>
<p>:param df_stage_four: The dataframe containing the data as processed to this point.
:param target_columns: The names of the columns in the input dataframe to be date_adjusted.
:param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame; If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe; If
        columns referenced in target_columns parameter cannot be found in the input dataframe.</p>
<p>:return: A dataframe holding data with the date adjustment method applied.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1122</span>
<span class="normal">1123</span>
<span class="normal">1124</span>
<span class="normal">1125</span>
<span class="normal">1126</span>
<span class="normal">1127</span>
<span class="normal">1128</span>
<span class="normal">1129</span>
<span class="normal">1130</span>
<span class="normal">1131</span>
<span class="normal">1132</span>
<span class="normal">1133</span>
<span class="normal">1134</span>
<span class="normal">1135</span>
<span class="normal">1136</span>
<span class="normal">1137</span>
<span class="normal">1138</span>
<span class="normal">1139</span>
<span class="normal">1140</span>
<span class="normal">1141</span>
<span class="normal">1142</span>
<span class="normal">1143</span>
<span class="normal">1144</span>
<span class="normal">1145</span>
<span class="normal">1146</span>
<span class="normal">1147</span>
<span class="normal">1148</span>
<span class="normal">1149</span>
<span class="normal">1150</span>
<span class="normal">1151</span>
<span class="normal">1152</span>
<span class="normal">1153</span>
<span class="normal">1154</span>
<span class="normal">1155</span>
<span class="normal">1156</span>
<span class="normal">1157</span>
<span class="normal">1158</span>
<span class="normal">1159</span>
<span class="normal">1160</span>
<span class="normal">1161</span>
<span class="normal">1162</span>
<span class="normal">1163</span>
<span class="normal">1164</span>
<span class="normal">1165</span>
<span class="normal">1166</span>
<span class="normal">1167</span>
<span class="normal">1168</span>
<span class="normal">1169</span>
<span class="normal">1170</span>
<span class="normal">1171</span>
<span class="normal">1172</span>
<span class="normal">1173</span>
<span class="normal">1174</span>
<span class="normal">1175</span>
<span class="normal">1176</span>
<span class="normal">1177</span>
<span class="normal">1178</span>
<span class="normal">1179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">date_adjustment_subfunction</span><span class="p">(</span>
    <span class="n">df_stage_four</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the data for further processing by the date adjustment and average weekly methods as required.</span>

<span class="sd">    :param df_stage_four: The dataframe containing the data as processed to this point.</span>
<span class="sd">    :param target_columns: The names of the columns in the input dataframe to be date_adjusted.</span>
<span class="sd">    :param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame; If the target columns parameter is not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe; If</span>
<span class="sd">            columns referenced in target_columns parameter cannot be found in the input dataframe.</span>

<span class="sd">    :return: A dataframe holding data with the date adjustment method applied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Basic validation</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="n">input_dataframe</span><span class="o">=</span><span class="n">df_stage_four</span><span class="p">,</span> <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns in input_dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;df_stage_four&quot;</span><span class="p">,</span> <span class="n">df_stage_four</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">da_method</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>

        <span class="c1"># SPP83 - AC 3</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E10&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># SPP83 - AC 2</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E11&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># SPP83 - AC 3</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
            <span class="n">da_col_name</span> <span class="o">=</span> <span class="s2">&quot;date_adjusted_&quot;</span> <span class="o">+</span> <span class="n">col</span>
            <span class="n">row</span><span class="p">[</span><span class="n">da_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">]</span>
                <span class="o">/</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">df_stage_five</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span><span class="n">df_stage_four</span><span class="p">,</span> <span class="n">da_method</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_five</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.generate_average_weekly_questions">
<code class="highlight language-python"><span class="n">generate_average_weekly_questions</span><span class="p">(</span><span class="n">average_weekly</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Generates the reference list that controls the average_weekly method.</p>
<p>:param String average_weekly: The average weekly parameter for the run. (Not the column name, the actual value.)
:param List[Strings] target_columns: The names of the columns in input_dataframe to be date_adjusted.</p>
<p>:raises TypeError: If the data held in column referenced by the target_columns_col parameter is not a list.</p>
<p>:returns: A list of validated columns to run the average_weekly method against.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">generate_average_weekly_questions</span><span class="p">(</span>
    <span class="n">average_weekly</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates the reference list that controls the average_weekly method.</span>

<span class="sd">    :param String average_weekly: The average weekly parameter for the run. (Not the column name, the actual value.)</span>
<span class="sd">    :param List[Strings] target_columns: The names of the columns in input_dataframe to be date_adjusted.</span>

<span class="sd">    :raises TypeError: If the data held in column referenced by the target_columns_col parameter is not a list.</span>

<span class="sd">    :returns: A list of validated columns to run the average_weekly method against.</span>


<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate target_columns is a list</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Param &quot;target_columns&quot; for function &#39;</span> <span class="o">+</span> <span class="n">this_place</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;should be of type List, not &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">target_columns</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">average_weekly</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
        <span class="n">average_weekly_questions_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="n">average_weekly</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
        <span class="n">average_weekly_questions_list</span> <span class="o">=</span> <span class="n">target_columns</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">average_weekly_questions_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">submitted_questions</span> <span class="o">=</span> <span class="n">_convert_question_string_to_list</span><span class="p">(</span><span class="n">average_weekly</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">submitted_questions</span><span class="p">:</span>
                <span class="n">average_weekly_questions_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="n">submitted_questions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">submitted_questions</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">column</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">submitted_questions</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ERROR: invalid average_weekly parameter contents.&quot;</span>

    <span class="k">return</span> <span class="n">average_weekly_questions_list</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.midpoint_subfunction">
<code class="highlight language-python"><span class="n">midpoint_subfunction</span><span class="p">(</span><span class="n">df_stage_two</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">domain_col</span><span class="p">,</span> <span class="n">expected_start_date_col</span><span class="p">,</span> <span class="n">expected_end_date_col</span><span class="p">,</span> <span class="n">contributor_returned_start_date_col</span><span class="p">,</span> <span class="n">contributor_returned_end_date_col</span><span class="p">,</span> <span class="n">set_to_mid_point_col</span><span class="p">,</span> <span class="n">equal_weighted_col</span><span class="p">,</span> <span class="n">use_calendar_days_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_period_start_col</span><span class="p">,</span> <span class="n">trading_period_end_col</span><span class="p">,</span> <span class="n">trading_weights_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Applies the midpoint method to the input data.</p>
<p>:param  df_stage_two: The dataframe containing the data as processed to this point.
:param  trading_weights: The trading day weight reference data required for processing.
:param  target_columns: The names of the columns in the input dataframe to be date_adjusted.
:param  domain_col: Name of the column holding the Domain in input_dataframe.
:param  set_to_mid_point_col: Name of the column holding the set to midpoint parameter.
:param  use_calendar_days_col: Name of the column holding the "use calendar days" option in input_dataframe.
:param  equal_weighted_col: Name of the column holding the "Set to equal weighted" option in input_dataframe.
:param  contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.
:param  contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.
:param  expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.
:param  expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.
:param  da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.
:param  trading_date_col: Name of the column holding the dates in trading_weights.
:param  trading_weights_col: Name of the column holding the weights in the trading_weights DataFrame.
:param  trading_domain_col: Name of the column holding the domain in the trading_weights DataFrame.
:param  trading_period_start_col: Name of the column holding the trading period start date in the trading_weights
        DataFrame.
:param  trading_period_end_col: Name of the column holding the trading period end date in the trading_weights
        DataFrame.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame.
:raises TypeError: If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe.
:raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</p>
<p>:return: A dataframe holding data with the midpoint method applied.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">midpoint_subfunction</span><span class="p">(</span>
    <span class="n">df_stage_two</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">trading_weights</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contributor_returned_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contributor_returned_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">set_to_mid_point_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">equal_weighted_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">use_calendar_days_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_period_start_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_period_end_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_weights_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the midpoint method to the input data.</span>

<span class="sd">    :param  df_stage_two: The dataframe containing the data as processed to this point.</span>
<span class="sd">    :param  trading_weights: The trading day weight reference data required for processing.</span>
<span class="sd">    :param  target_columns: The names of the columns in the input dataframe to be date_adjusted.</span>
<span class="sd">    :param  domain_col: Name of the column holding the Domain in input_dataframe.</span>
<span class="sd">    :param  set_to_mid_point_col: Name of the column holding the set to midpoint parameter.</span>
<span class="sd">    :param  use_calendar_days_col: Name of the column holding the &quot;use calendar days&quot; option in input_dataframe.</span>
<span class="sd">    :param  equal_weighted_col: Name of the column holding the &quot;Set to equal weighted&quot; option in input_dataframe.</span>
<span class="sd">    :param  contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.</span>
<span class="sd">    :param  contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.</span>
<span class="sd">    :param  expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.</span>
<span class="sd">    :param  expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.</span>
<span class="sd">    :param  da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>
<span class="sd">    :param  trading_date_col: Name of the column holding the dates in trading_weights.</span>
<span class="sd">    :param  trading_weights_col: Name of the column holding the weights in the trading_weights DataFrame.</span>
<span class="sd">    :param  trading_domain_col: Name of the column holding the domain in the trading_weights DataFrame.</span>
<span class="sd">    :param  trading_period_start_col: Name of the column holding the trading period start date in the trading_weights</span>
<span class="sd">            DataFrame.</span>
<span class="sd">    :param  trading_period_end_col: Name of the column holding the trading period end date in the trading_weights</span>
<span class="sd">            DataFrame.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame.</span>
<span class="sd">    :raises TypeError: If the target columns parameter is not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe.</span>
<span class="sd">    :raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</span>

<span class="sd">    :return: A dataframe holding data with the midpoint method applied.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Basic validation checks</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="n">input_dataframe</span><span class="o">=</span><span class="n">df_stage_two</span><span class="p">,</span> <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns are in df_stage_two dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">domain_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">use_calendar_days_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;df_stage_two&quot;</span><span class="p">,</span> <span class="n">df_stage_two</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="n">working_dataframe</span> <span class="o">=</span> <span class="n">df_stage_two</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">mid_point_process</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="c1"># Rule 3.3, flow chart 11,9: If midpoint not Y or YT, set defaults of APx = EPx.</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">set_to_mid_point_col</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;YT&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">equal_weighted_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>  <span class="c1"># Flowchart 7a</span>
                <span class="n">row</span><span class="p">[</span><span class="n">set_to_mid_point_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Flowchart 7b</span>
                <span class="c1"># Set CRPS to earliest date &gt;= CRPS with non-zero weight in same domain.</span>
                <span class="n">non_zero_after_crps</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span>
                        <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">trading_date_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># set CRPS, error if reference df is empty.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero_after_crps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Flowchart 7c</span>
                    <span class="n">min_date_index</span> <span class="o">=</span> <span class="n">non_zero_after_crps</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_zero_after_crps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">min_date_index</span><span class="p">,</span> <span class="n">trading_date_col</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span>
                        <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E12&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">row</span>

                <span class="c1"># CRPE = latest period &lt;= CRPE with non-zero weight</span>
                <span class="n">non_zero_before_crpe</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span>
                        <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
                <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">trading_date_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># set CRPE, error if reference df is empty.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero_before_crpe</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Not on flowchart, added in testing.</span>
                    <span class="n">max_date_index</span> <span class="o">=</span> <span class="n">non_zero_before_crpe</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
                    <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_zero_before_crpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span>
                        <span class="n">max_date_index</span><span class="p">,</span> <span class="n">trading_date_col</span>
                    <span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span>
                        <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E12&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">row</span>

            <span class="c1"># Calculate midpoint  (Flowchart #8)</span>
            <span class="n">date_diff</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">additional_days</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="p">(</span><span class="n">date_diff</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">date_diff</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">((</span><span class="n">date_diff</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Subtracting 1 from additional days as methodology count the the start date</span>
            <span class="c1"># as day one. (ie they add 20 to 10 and get 29! :)</span>
            <span class="n">midpoint_date</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span>
                <span class="n">days</span><span class="o">=</span><span class="p">(</span><span class="n">additional_days</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;midpoint_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_date</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date_change_in_return_period_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="c1"># Use midpoint date value</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">expected_start_date_col</span><span class="p">]</span>
                <span class="o">&lt;=</span> <span class="n">midpoint_date</span>
                <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="n">expected_end_date_col</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="c1"># Flowchart #10a</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date_change_in_return_period_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;C&quot;</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">use_calendar_days_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                    <span class="c1"># Flowchart #10b</span>
                    <span class="n">first_day</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">last_day</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="n">midpoint_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">midpoint_date</span><span class="o">.</span><span class="n">month</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
                        <span class="n">year</span><span class="o">=</span><span class="n">midpoint_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                        <span class="n">month</span><span class="o">=</span><span class="n">midpoint_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                        <span class="n">day</span><span class="o">=</span><span class="n">first_day</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span>
                        <span class="n">year</span><span class="o">=</span><span class="n">midpoint_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">midpoint_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">last_day</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Flowchart #10c</span>
                    <span class="n">midpoint_data</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">midpoint_date</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
                    <span class="p">]</span>
                    <span class="c1"># Use midpoint date trading period dates.</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">midpoint_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Not on flowchart, added in testing.</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_data</span><span class="p">[</span>
                            <span class="n">trading_period_start_col</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint_data</span><span class="p">[</span>
                            <span class="n">trading_period_end_col</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># Error if it doesnt exist (or theres a duplicate row). This is</span>
                    <span class="c1"># normally picked up by E06 but in the case where a record had the</span>
                    <span class="c1"># wrong trading period date, there will be one missing, and one</span>
                    <span class="c1"># extra, which spoofs the tests for E06.</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span>
                            <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E13&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span>
                        <span class="p">)</span>
                        <span class="k">return</span> <span class="n">row</span>
                <span class="k">return</span> <span class="n">row</span>  <span class="c1"># From flowchart position 10b or 10c</span>

        <span class="c1"># Flowchart #9</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">expected_start_date_col</span><span class="p">]</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">expected_end_date_col</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">row</span>  <span class="c1"># From flowchart position 9</span>

    <span class="n">df_stage_three</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span><span class="n">working_dataframe</span><span class="p">,</span> <span class="n">mid_point_process</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_three</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.missing_value_subfunction">
<code class="highlight language-python"><span class="n">missing_value_subfunction</span><span class="p">(</span><span class="n">input_dataframe</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Checks the target columns for missing data.</p>
<p>:param input_dataframe: The dataframe containing the data to be processed plus processing options.
:param target_columns: The names of the columns in input_dataframe to be date_adjusted.
:param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame.
:raises TypeError: If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe.
:raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</p>
<p>:returns: Data with rows that have missing data in the target columns marked with an error flag.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">missing_value_subfunction</span><span class="p">(</span>
    <span class="n">input_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks the target columns for missing data.</span>

<span class="sd">    :param input_dataframe: The dataframe containing the data to be processed plus processing options.</span>
<span class="sd">    :param target_columns: The names of the columns in input_dataframe to be date_adjusted.</span>
<span class="sd">    :param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame.</span>
<span class="sd">    :raises TypeError: If the target columns parameter is not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe.</span>
<span class="sd">    :raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</span>

<span class="sd">    :returns: Data with rows that have missing data in the target columns marked with an error flag.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="n">input_dataframe</span><span class="o">=</span><span class="n">input_dataframe</span><span class="p">,</span> <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns in input_dataframe</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;input_dataframe&quot;</span><span class="p">,</span> <span class="n">input_dataframe</span><span class="p">,</span> <span class="n">target_columns</span>
    <span class="p">)</span>

    <span class="c1"># Create working copy of input dataframe</span>
    <span class="n">working_dataframe</span> <span class="o">=</span> <span class="n">input_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Add the error flag column for future use and output.</span>
    <span class="n">working_dataframe</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Check and apply the error flag as appropriate</span>
    <span class="k">def</span> <span class="nf">check_for_null</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">target_column</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">target_column</span><span class="p">])</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="n">target_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">row</span><span class="p">[</span><span class="n">da_error_flag_col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;E01&quot;</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">df_stage_one</span> <span class="o">=</span> <span class="n">working_dataframe</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">check_for_null</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_one</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.primary_wrangler_subfunction">
<code class="highlight language-python"><span class="n">primary_wrangler_subfunction</span><span class="p">(</span><span class="n">df_stage_one</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">contributor_returned_start_date_col</span><span class="p">,</span> <span class="n">contributor_returned_end_date_col</span><span class="p">,</span> <span class="n">expected_start_date_col</span><span class="p">,</span> <span class="n">expected_end_date_col</span><span class="p">,</span> <span class="n">domain_col</span><span class="p">,</span> <span class="n">equal_weighted_col</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_weights_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Prepares the data for further processing by the midpoint method if required.</p>
<p>:param df_stage_one: The dataframe containing the data as processed to this point.
:param trading_weights: The trading day weight reference data required for processing.
:param target_columns: The names of the columns in the input dataframe to be date_adjusted.
:param contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.
:param contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.
:param expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.
:param expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.
:param domain_col: Name of the column holding the Domain in input_dataframe.
:param equal_weighted_col: Name of the column holding the "Set to equal weighted" option in input_dataframe.
:param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.
:param trading_date_col: Name of the column holding the dates in trading_weights.
:param trading_weights_col: Name of the column holding the weights in trading_weights.
:param trading_domain_col: Name of the column holding the domain in trading_weights.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame.
:raises TypeError: If the trading weights reference data is not a DataFrame.
:raises TypeError: If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the
        trading weights dataframe as appropriate.
:raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</p>
<p>:return: A dataframe holding data and structure ready to be passed into the midpoint method sub-function.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">primary_wrangler_subfunction</span><span class="p">(</span>
    <span class="n">df_stage_one</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">trading_weights</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">contributor_returned_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contributor_returned_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">equal_weighted_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_weights_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the data for further processing by the midpoint method if required.</span>

<span class="sd">    :param df_stage_one: The dataframe containing the data as processed to this point.</span>
<span class="sd">    :param trading_weights: The trading day weight reference data required for processing.</span>
<span class="sd">    :param target_columns: The names of the columns in the input dataframe to be date_adjusted.</span>
<span class="sd">    :param contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.</span>
<span class="sd">    :param contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.</span>
<span class="sd">    :param expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.</span>
<span class="sd">    :param expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.</span>
<span class="sd">    :param domain_col: Name of the column holding the Domain in input_dataframe.</span>
<span class="sd">    :param equal_weighted_col: Name of the column holding the &quot;Set to equal weighted&quot; option in input_dataframe.</span>
<span class="sd">    :param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>
<span class="sd">    :param trading_date_col: Name of the column holding the dates in trading_weights.</span>
<span class="sd">    :param trading_weights_col: Name of the column holding the weights in trading_weights.</span>
<span class="sd">    :param trading_domain_col: Name of the column holding the domain in trading_weights.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame.</span>
<span class="sd">    :raises TypeError: If the trading weights reference data is not a DataFrame.</span>
<span class="sd">    :raises TypeError: If the target columns parameter is not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the</span>
<span class="sd">            trading weights dataframe as appropriate.</span>
<span class="sd">    :raises KeyError: If columns referenced in target_columns parameter cannot be found in the input dataframe.</span>

<span class="sd">    :return: A dataframe holding data and structure ready to be passed into the midpoint method sub-function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>

    <span class="c1"># Basic validation checks</span>
    <span class="c1"># noinspection PyProtectedMember</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span>
        <span class="n">input_dataframe</span><span class="o">=</span><span class="n">df_stage_one</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="o">=</span><span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns are in input dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
        <span class="n">equal_weighted_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">target_columns</span><span class="p">:</span>
        <span class="n">required_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;df_stage_one&quot;</span><span class="p">,</span> <span class="n">df_stage_one</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns are in trading_weights dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">trading_weights_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;trading_weights&quot;</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="n">working_dataframe</span> <span class="o">=</span> <span class="n">df_stage_one</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Rule 3.1 &amp; 3.2</span>

    <span class="k">def</span> <span class="nf">fix_dates</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>

        <span class="c1">#  Ensure we have the EPS and EPE dates and they are valid.</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expected_start_date_col</span><span class="p">]):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E14&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">expected_end_date_col</span><span class="p">]):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E15&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row</span>

        <span class="c1"># Fix NaT start date</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">expected_start_date_col</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">],</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Fix NaT end date</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">expected_end_date_col</span><span class="p">]</span>
            <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="n">working_dataframe</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span><span class="n">working_dataframe</span><span class="p">,</span> <span class="n">fix_dates</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span>

    <span class="c1"># Rule 3.3, 3.4, 3.5, 3.6, 3.7</span>

    <span class="k">def</span> <span class="nf">preliminary_stages</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="c1"># Set defaults</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Calculate actual or flags.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E02&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">equal_weighted_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span>
                    <span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span>
                        <span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span>
                        <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span>
                        <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="n">filtered_weights</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">filtered_weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">_idx</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">filtered_weights</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">4</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                                    <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">5</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]):</span>
                                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">4</span>
                            <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">flagged</span><span class="p">:</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span>
                        <span class="n">row</span><span class="p">,</span>
                        <span class="s2">&quot;E0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_code_number</span><span class="p">),</span>
                        <span class="n">da_error_flag_col</span><span class="p">,</span>
                        <span class="n">target_columns</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">row</span><span class="p">[</span>
                        <span class="s2">&quot;sum_of_trading_day_weights_over_contributors_returned_period&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">filtered_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">row</span>

    <span class="n">df_stage_two</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span><span class="n">working_dataframe</span><span class="p">,</span> <span class="n">preliminary_stages</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_two</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>

<div class="doc doc-object doc-function">



<h2 class="doc doc-heading" id="sml_small.date_adjustment.secondary_wrangler_subfunction">
<code class="highlight language-python"><span class="n">secondary_wrangler_subfunction</span><span class="p">(</span><span class="n">df_stage_three</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">,</span> <span class="n">contributor_returned_start_date_col</span><span class="p">,</span> <span class="n">contributor_returned_end_date_col</span><span class="p">,</span> <span class="n">expected_start_date_col</span><span class="p">,</span> <span class="n">expected_end_date_col</span><span class="p">,</span> <span class="n">domain_col</span><span class="p">,</span> <span class="n">equal_weighted_col</span><span class="p">,</span> <span class="n">set_to_mid_point_col</span><span class="p">,</span> <span class="n">short_period_parameter_col</span><span class="p">,</span> <span class="n">long_period_parameter_col</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">,</span> <span class="n">trading_weights_col</span><span class="p">)</span></code>

</h2>


  <div class="doc doc-contents ">
  
      <p>Prepares the data for further processing by the date adjustment and average weekly methods as required.</p>
<p>:param df_stage_three: The dataframe containing the data as processed to this point.
:param trading_weights: The trading day weight reference data required for processing.
:param target_columns: The names of the columns in the input dataframe to be date_adjusted.
:param contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.
:param contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.
:param expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.
:param expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.
:param domain_col: Name of the column holding the Domain in input_dataframe.
:param equal_weighted_col: Name of the column holding the "Set to equal weighted" option in input_dataframe.
:param short_period_parameter_col: Name of the column holding the "short period parameter" in input_dataframe.
:param long_period_parameter_col: Name of the column holding the "long period parameter" in input_dataframe.
:param set_to_mid_point_col: Name of the column holding the "Set to mid-point" option in input_dataframe.
:param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.
:param trading_date_col: Name of the column holding the dates in trading_weights.
:param trading_weights_col: Name of the column holding the weights in trading_weights.
:param trading_domain_col: Name of the column holding the domain in trading_weights.</p>
<p>:raises TypeError: If the input dataframe is not a DataFrame; If the trading weights reference data is not a
        DataFrame; If the target columns parameter is not a List.
:raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the
        trading weights dataframe as appropriate; If columns referenced in target_columns parameter cannot be
        found in the input dataframe.</p>
<p>:return: A dataframe holding data and structure ready to be passed into the midpoint method sub-function.</p>

      <details class="quote">
        <summary>Source code in <code>sml_small/date_adjustment.py</code></summary>
        <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 896</span>
<span class="normal"> 897</span>
<span class="normal"> 898</span>
<span class="normal"> 899</span>
<span class="normal"> 900</span>
<span class="normal"> 901</span>
<span class="normal"> 902</span>
<span class="normal"> 903</span>
<span class="normal"> 904</span>
<span class="normal"> 905</span>
<span class="normal"> 906</span>
<span class="normal"> 907</span>
<span class="normal"> 908</span>
<span class="normal"> 909</span>
<span class="normal"> 910</span>
<span class="normal"> 911</span>
<span class="normal"> 912</span>
<span class="normal"> 913</span>
<span class="normal"> 914</span>
<span class="normal"> 915</span>
<span class="normal"> 916</span>
<span class="normal"> 917</span>
<span class="normal"> 918</span>
<span class="normal"> 919</span>
<span class="normal"> 920</span>
<span class="normal"> 921</span>
<span class="normal"> 922</span>
<span class="normal"> 923</span>
<span class="normal"> 924</span>
<span class="normal"> 925</span>
<span class="normal"> 926</span>
<span class="normal"> 927</span>
<span class="normal"> 928</span>
<span class="normal"> 929</span>
<span class="normal"> 930</span>
<span class="normal"> 931</span>
<span class="normal"> 932</span>
<span class="normal"> 933</span>
<span class="normal"> 934</span>
<span class="normal"> 935</span>
<span class="normal"> 936</span>
<span class="normal"> 937</span>
<span class="normal"> 938</span>
<span class="normal"> 939</span>
<span class="normal"> 940</span>
<span class="normal"> 941</span>
<span class="normal"> 942</span>
<span class="normal"> 943</span>
<span class="normal"> 944</span>
<span class="normal"> 945</span>
<span class="normal"> 946</span>
<span class="normal"> 947</span>
<span class="normal"> 948</span>
<span class="normal"> 949</span>
<span class="normal"> 950</span>
<span class="normal"> 951</span>
<span class="normal"> 952</span>
<span class="normal"> 953</span>
<span class="normal"> 954</span>
<span class="normal"> 955</span>
<span class="normal"> 956</span>
<span class="normal"> 957</span>
<span class="normal"> 958</span>
<span class="normal"> 959</span>
<span class="normal"> 960</span>
<span class="normal"> 961</span>
<span class="normal"> 962</span>
<span class="normal"> 963</span>
<span class="normal"> 964</span>
<span class="normal"> 965</span>
<span class="normal"> 966</span>
<span class="normal"> 967</span>
<span class="normal"> 968</span>
<span class="normal"> 969</span>
<span class="normal"> 970</span>
<span class="normal"> 971</span>
<span class="normal"> 972</span>
<span class="normal"> 973</span>
<span class="normal"> 974</span>
<span class="normal"> 975</span>
<span class="normal"> 976</span>
<span class="normal"> 977</span>
<span class="normal"> 978</span>
<span class="normal"> 979</span>
<span class="normal"> 980</span>
<span class="normal"> 981</span>
<span class="normal"> 982</span>
<span class="normal"> 983</span>
<span class="normal"> 984</span>
<span class="normal"> 985</span>
<span class="normal"> 986</span>
<span class="normal"> 987</span>
<span class="normal"> 988</span>
<span class="normal"> 989</span>
<span class="normal"> 990</span>
<span class="normal"> 991</span>
<span class="normal"> 992</span>
<span class="normal"> 993</span>
<span class="normal"> 994</span>
<span class="normal"> 995</span>
<span class="normal"> 996</span>
<span class="normal"> 997</span>
<span class="normal"> 998</span>
<span class="normal"> 999</span>
<span class="normal">1000</span>
<span class="normal">1001</span>
<span class="normal">1002</span>
<span class="normal">1003</span>
<span class="normal">1004</span>
<span class="normal">1005</span>
<span class="normal">1006</span>
<span class="normal">1007</span>
<span class="normal">1008</span>
<span class="normal">1009</span>
<span class="normal">1010</span>
<span class="normal">1011</span>
<span class="normal">1012</span>
<span class="normal">1013</span>
<span class="normal">1014</span>
<span class="normal">1015</span>
<span class="normal">1016</span>
<span class="normal">1017</span>
<span class="normal">1018</span>
<span class="normal">1019</span>
<span class="normal">1020</span>
<span class="normal">1021</span>
<span class="normal">1022</span>
<span class="normal">1023</span>
<span class="normal">1024</span>
<span class="normal">1025</span>
<span class="normal">1026</span>
<span class="normal">1027</span>
<span class="normal">1028</span>
<span class="normal">1029</span>
<span class="normal">1030</span>
<span class="normal">1031</span>
<span class="normal">1032</span>
<span class="normal">1033</span>
<span class="normal">1034</span>
<span class="normal">1035</span>
<span class="normal">1036</span>
<span class="normal">1037</span>
<span class="normal">1038</span>
<span class="normal">1039</span>
<span class="normal">1040</span>
<span class="normal">1041</span>
<span class="normal">1042</span>
<span class="normal">1043</span>
<span class="normal">1044</span>
<span class="normal">1045</span>
<span class="normal">1046</span>
<span class="normal">1047</span>
<span class="normal">1048</span>
<span class="normal">1049</span>
<span class="normal">1050</span>
<span class="normal">1051</span>
<span class="normal">1052</span>
<span class="normal">1053</span>
<span class="normal">1054</span>
<span class="normal">1055</span>
<span class="normal">1056</span>
<span class="normal">1057</span>
<span class="normal">1058</span>
<span class="normal">1059</span>
<span class="normal">1060</span>
<span class="normal">1061</span>
<span class="normal">1062</span>
<span class="normal">1063</span>
<span class="normal">1064</span>
<span class="normal">1065</span>
<span class="normal">1066</span>
<span class="normal">1067</span>
<span class="normal">1068</span>
<span class="normal">1069</span>
<span class="normal">1070</span>
<span class="normal">1071</span>
<span class="normal">1072</span>
<span class="normal">1073</span>
<span class="normal">1074</span>
<span class="normal">1075</span>
<span class="normal">1076</span>
<span class="normal">1077</span>
<span class="normal">1078</span>
<span class="normal">1079</span>
<span class="normal">1080</span>
<span class="normal">1081</span>
<span class="normal">1082</span>
<span class="normal">1083</span>
<span class="normal">1084</span>
<span class="normal">1085</span>
<span class="normal">1086</span>
<span class="normal">1087</span>
<span class="normal">1088</span>
<span class="normal">1089</span>
<span class="normal">1090</span>
<span class="normal">1091</span>
<span class="normal">1092</span>
<span class="normal">1093</span>
<span class="normal">1094</span>
<span class="normal">1095</span>
<span class="normal">1096</span>
<span class="normal">1097</span>
<span class="normal">1098</span>
<span class="normal">1099</span>
<span class="normal">1100</span>
<span class="normal">1101</span>
<span class="normal">1102</span>
<span class="normal">1103</span>
<span class="normal">1104</span>
<span class="normal">1105</span>
<span class="normal">1106</span>
<span class="normal">1107</span>
<span class="normal">1108</span>
<span class="normal">1109</span>
<span class="normal">1110</span>
<span class="normal">1111</span>
<span class="normal">1112</span>
<span class="normal">1113</span>
<span class="normal">1114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">secondary_wrangler_subfunction</span><span class="p">(</span>
    <span class="n">df_stage_three</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">trading_weights</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">target_columns</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span>
    <span class="n">contributor_returned_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">contributor_returned_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_start_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">expected_end_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">equal_weighted_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">set_to_mid_point_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">short_period_parameter_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">long_period_parameter_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">da_error_flag_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_date_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_domain_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">trading_weights_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the data for further processing by the date adjustment and average weekly methods as required.</span>

<span class="sd">    :param df_stage_three: The dataframe containing the data as processed to this point.</span>
<span class="sd">    :param trading_weights: The trading day weight reference data required for processing.</span>
<span class="sd">    :param target_columns: The names of the columns in the input dataframe to be date_adjusted.</span>
<span class="sd">    :param contributor_returned_start_date_col: Name of the column holding the contributors returned period start date.</span>
<span class="sd">    :param contributor_returned_end_date_col: Name of the column holding the contributors returned period end date.</span>
<span class="sd">    :param expected_start_date_col: Name of the column holding the expected period start date in input_dataframe.</span>
<span class="sd">    :param expected_end_date_col: Name of the column holding the expected period end date in input_dataframe.</span>
<span class="sd">    :param domain_col: Name of the column holding the Domain in input_dataframe.</span>
<span class="sd">    :param equal_weighted_col: Name of the column holding the &quot;Set to equal weighted&quot; option in input_dataframe.</span>
<span class="sd">    :param short_period_parameter_col: Name of the column holding the &quot;short period parameter&quot; in input_dataframe.</span>
<span class="sd">    :param long_period_parameter_col: Name of the column holding the &quot;long period parameter&quot; in input_dataframe.</span>
<span class="sd">    :param set_to_mid_point_col: Name of the column holding the &quot;Set to mid-point&quot; option in input_dataframe.</span>
<span class="sd">    :param da_error_flag_col: Name of the column that the user wishes the error flag column to be called in the output.</span>
<span class="sd">    :param trading_date_col: Name of the column holding the dates in trading_weights.</span>
<span class="sd">    :param trading_weights_col: Name of the column holding the weights in trading_weights.</span>
<span class="sd">    :param trading_domain_col: Name of the column holding the domain in trading_weights.</span>

<span class="sd">    :raises TypeError: If the input dataframe is not a DataFrame; If the trading weights reference data is not a</span>
<span class="sd">            DataFrame; If the target columns parameter is not a List.</span>
<span class="sd">    :raises KeyError: If required columns referenced in the parameters cannot be found in the input dataframe or the</span>
<span class="sd">            trading weights dataframe as appropriate; If columns referenced in target_columns parameter cannot be</span>
<span class="sd">            found in the input dataframe.</span>

<span class="sd">    :return: A dataframe holding data and structure ready to be passed into the midpoint method sub-function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic validation</span>
    <span class="c1"># noinspection PyProtectedMember,PyUnresolvedReferences</span>
    <span class="n">this_place</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_name</span>
    <span class="n">_basic_input_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span>
        <span class="n">input_dataframe</span><span class="o">=</span><span class="n">df_stage_three</span><span class="p">,</span>
        <span class="n">trading_weights</span><span class="o">=</span><span class="n">trading_weights</span><span class="p">,</span>
        <span class="n">target_columns</span><span class="o">=</span><span class="n">target_columns</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns in input_dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">contributor_returned_start_date_col</span><span class="p">,</span>
        <span class="n">contributor_returned_end_date_col</span><span class="p">,</span>
        <span class="n">expected_start_date_col</span><span class="p">,</span>
        <span class="n">expected_end_date_col</span><span class="p">,</span>
        <span class="n">set_to_mid_point_col</span><span class="p">,</span>
        <span class="n">short_period_parameter_col</span><span class="p">,</span>
        <span class="n">long_period_parameter_col</span><span class="p">,</span>
        <span class="n">da_error_flag_col</span><span class="p">,</span>
        <span class="n">domain_col</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;df_stage_three&quot;</span><span class="p">,</span> <span class="n">df_stage_three</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="c1"># Validate required columns are in trading_weights dataframe</span>
    <span class="n">required_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">trading_weights_col</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">,</span> <span class="n">trading_domain_col</span><span class="p">]</span>
    <span class="n">_required_column_validation</span><span class="p">(</span>
        <span class="n">this_place</span><span class="p">,</span> <span class="s2">&quot;trading_weights&quot;</span><span class="p">,</span> <span class="n">trading_weights</span><span class="p">,</span> <span class="n">required_columns</span>
    <span class="p">)</span>

    <span class="n">working_df_1</span> <span class="o">=</span> <span class="n">df_stage_three</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Rule 3.3, flow chart 12a: If midpoint not YT, set N to APE - APN,</span>
    <span class="c1">#   else 12b: set N to trimmed APE - APN.</span>
    <span class="k">def</span> <span class="nf">mid_point_not_equal_yt</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">set_to_mid_point_col</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;YT&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_actual_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">])</span>
            <span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set APS to earliest date &gt;= APS with non-zero weight in same domain.</span>
            <span class="n">non_zero_after_aps</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="p">[</span>
                <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">trading_date_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># set APS as weights will always exist due to earlier checks.</span>
            <span class="n">min_date_index</span> <span class="o">=</span> <span class="n">non_zero_after_aps</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
            <span class="n">aps</span> <span class="o">=</span> <span class="n">non_zero_after_aps</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">min_date_index</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">]</span>

            <span class="c1"># APE = latest period &lt;= APE with non-zero weight</span>
            <span class="n">non_zero_before_ape</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="p">[</span>
                <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">trading_date_col</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># set APE as weights will always exist due to earlier checks.</span>
            <span class="n">max_date_index</span> <span class="o">=</span> <span class="n">non_zero_before_ape</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
            <span class="n">ape</span> <span class="o">=</span> <span class="n">non_zero_before_ape</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">max_date_index</span><span class="p">,</span> <span class="n">trading_date_col</span><span class="p">]</span>

            <span class="c1"># Set N using trimmed APS and APE.</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_actual_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ape</span> <span class="o">-</span> <span class="n">aps</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">row</span>

    <span class="n">working_dataframe_2</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span>
        <span class="n">working_df_1</span><span class="p">,</span> <span class="n">mid_point_not_equal_yt</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="c1"># Rule 5.4,5.5, flow chart 19:</span>
    <span class="k">def</span> <span class="nf">short_and_long_parameter_validation</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="c1"># 5.4 If less than short period parameter, mark length flag as &#39;S&#39;</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="n">short_period_parameter_col</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date_adjustment_length_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;S&quot;</span>
        <span class="c1"># 5.5 If greater than Long period parameter, mark length flag as &#39;L&#39;</span>
        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_contributors_returned_period&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="n">long_period_parameter_col</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date_adjustment_length_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span>
        <span class="c1"># 5.4,5.5 If params wrong way round, output &#39;SL&#39; to flag.</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">short_period_parameter_col</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">long_period_parameter_col</span><span class="p">]):</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date_adjustment_length_flag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SL&quot;</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">working_dataframe_3</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span>
        <span class="n">working_dataframe_2</span><span class="p">,</span> <span class="n">short_and_long_parameter_validation</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_weights_n</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">equal_weighted_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span>
                <span class="s2">&quot;number_of_days_in_actual_returned_period&quot;</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flagged</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_start_date&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_date_col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;actual_period_end_date&quot;</span><span class="p">])</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="n">trading_weights</span><span class="p">[</span><span class="n">trading_domain_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="n">domain_col</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">filtered_weights</span> <span class="o">=</span> <span class="n">trading_weights</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">filtered_weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;number_of_days_in_actual_returned_period&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_idx</span><span class="p">,</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">filtered_weights</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">7</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">8</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]):</span>
                            <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">7</span>
                        <span class="k">if</span> <span class="n">record</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">flagged</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">error_code_number</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="k">if</span> <span class="n">flagged</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">,</span>
                    <span class="s2">&quot;E0&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_code_number</span><span class="p">),</span>
                    <span class="n">da_error_flag_col</span><span class="p">,</span>
                    <span class="n">target_columns</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span><span class="p">[</span>
                    <span class="s2">&quot;sum_of_trading_day_weights_over_actual_returned_period&quot;</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">filtered_weights</span><span class="p">[</span><span class="n">trading_weights_col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">working_dataframe_4</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span>
        <span class="n">working_dataframe_3</span><span class="p">,</span> <span class="n">create_weights_n</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">span_overlap_less_than_one_day</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="n">latest_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="n">expected_start_date_col</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_start_date_col</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">earliest_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">row</span><span class="p">[</span><span class="n">expected_end_date_col</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">contributor_returned_end_date_col</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">earliest_end</span> <span class="o">-</span> <span class="n">latest_start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">span</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">set_to_mid_point_col</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;N&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">span</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">_apply_error_flag</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="s2">&quot;E09&quot;</span><span class="p">,</span> <span class="n">da_error_flag_col</span><span class="p">,</span> <span class="n">target_columns</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="n">df_stage_four</span> <span class="o">=</span> <span class="n">_run_apply</span><span class="p">(</span>
        <span class="n">working_dataframe_4</span><span class="p">,</span> <span class="n">span_overlap_less_than_one_day</span><span class="p">,</span> <span class="n">da_error_flag_col</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">df_stage_four</span>
</code></pre></div></td></tr></table></div>
      </details>
  </div>

</div>



  </div>

  </div>

</div></p>
    </article>
</section>
        
            <!--

-->

<li >
    <a href="..">Home</a>
</li>

          
            <!--

-->

<li >
    <a href="../content/">Content</a>
</li>

          
                                    </main>
                                </div>
                            </div>
                        </div>
                    

                    
                </div>
                
                
                    
                        

    
    

    
        
    

    

    <footer class="ons-footer">

        

        

        <div class="ons-footer__body ons-page__footer" data-analytics="footer" >
            <div class="ons-container">
                <div class="ons-grid">
                    

                    

                    
                </div>

                <div class="ons-grid ons-grid--flex ons-grid--vertical-top ons-grid--between">
                    <div class="ons-grid__col">
                        

                        
                            <!-- OGL -->
                            <div class="ons-footer__license ons-u-mb-m">
                                

    

    
    
        <svg class="ons-footer__ogl-img" xmlns="http://www.w3.org/2000/svg" width="50px" height="20px" viewBox="0 0 60 24" focusable="false" aria-hidden="true">
            <title>Open Government License logo</title>
            <path d="M51.7,17.5V0l-6.2,4v19.8h13.8v-6.2H51.7z M36.7,16.3c-1,0.9-2.4,1.4-3.8,1.4c-3.2,0-5.8-2.6-5.8-5.8s2.6-5.8,5.8-5.8c2,0,3.9,1.1,4.9,2.7L43,5.6C40.9,2.2,37.1,0,32.9,0c-4.5,0-8.4,2.5-10.4,6.1C20.4,2.5,16.5,0,12,0C5.4,0,0,5.4,0,12s5.4,12,12,12c4.5,0,8.4-2.5,10.4-6.1c2.1,3.6,6,6.1,10.4,6.1c3,0,5.8-1.1,7.9-3l2.4,2.7h0.4V13h-9.8L36.7,16.3zM12,17.8c-3.2,0-5.8-2.6-5.8-5.8S8.8,6.2,12,6.2s5.8,2.6,5.8,5.8S15.2,17.8,12,17.8" fill="#595959"></path>
        </svg>
    
    

                                
                                    
                                    
                                        All content is available under the 
    <a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" class="ons-external-link" target="_blank" rel="noopener">
        <span class="ons-external-link__text">Open Government Licence v3.0</span><span class="ons-external-link__icon">&nbsp;<svg class="ons-svg-icon" viewBox="0 0 12 12" xmlns="http://www.w3.org/2000/svg" focusable="false" aria-hidden="true">
        <path d="M13.5,9H13a.5.5,0,0,0-.5.5v3h-9v-9h3A.5.5,0,0,0,7,3V2.5A.5.5,0,0,0,6.5,2h-4a.5.5,0,0,0-.5.5v11a.5.5,0,0,0,.5.5h11a.5.5,0,0,0,.5-.5v-4A.5.5,0,0,0,13.5,9Z" transform="translate(-2 -1.99)"/>
        <path d="M8.83,7.88a.51.51,0,0,0,.71,0l2.31-2.32,1.28,1.28A.51.51,0,0,0,14,6.49v-4a.52.52,0,0,0-.5-.5h-4A.51.51,0,0,0,9,2.52a.58.58,0,0,0,.14.33l1.28,1.28L8.12,6.46a.51.51,0,0,0,0,.71Z" transform="translate(-2 -1.99)"/>
    </svg></span><span class="ons-external-link__new-window-description ons-u-vh"> (opens in a new tab)</span></a>
, except where otherwise stated
                                    
                                
                            </div>
                        
                        
                            <div class="ons-footer__poweredby ons-u-mb-m">
                                
        
            

    

    
    
        <svg class="ons-svg-logo" xmlns="http://www.w3.org/2000/svg" width="197" height="19" viewBox="33 2 552 60" aria-labelledby="ons-logo-en-footer-alt">
            <title id="ons-logo-en-footer-alt">Office for National Statistics</title>
            <g class="ons-svg-logo__group ons-svg-logo__group--secondary" fill="#a8bd3a">
                <path d="M0,34.6c.8-1.69,1.39-3,2.32-4.6A38.28,38.28,0,0,1,0,23.4V34.6M5,3S0,3,0,9.25v1A62.12,62.12,0,0,0,4.2,27a43.77,43.77,0,0,1,9.42-10.79C21.69,9.21,31.16,5.13,45.9,3Z"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--primary" fill="#003c57">
                <path d="M53.06,6.42C36.2,8,24.68,12.92,16.43,20.07A41.46,41.46,0,0,0,6.4,32.2C12.87,44.93,28.88,57,46.6,57H47s6.32.21,6.32-6.91V6.36a1.22,1.22,0,0,1-.26.06M9.72,42.67a44.25,44.25,0,0,1-5-7.42A80.59,80.59,0,0,0,0,46.38V56.91L31.06,57c-9.83-3-15.74-7.64-21.34-14.3"/>
            </g>
            <g class="ons-svg-logo__group ons-svg-logo__group--text" fill="#003c57">
                <path d="M82,47.49c-9.07,0-13.13-7.51-13.13-16.77S72.91,14,82,14s13.1,7.61,13.1,16.77S91.1,47.54,82,47.54m0-30.91c-6.69,0-9.07,7.33-9.07,14.05s2.16,13.9,9.07,13.9,9-7.28,9-13.9-2.34-14-9-14"/>
                <path d="M106.36,23.81V46.88h-3.67V23.81H98.93V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.38,0,.86.05.86.05v2.35h-.43c-2.55,0-4.84,1.64-4.84,5.12v4.09h5.27v2.25Z"/>
                <path d="M121.53,23.81V46.88h-3.67V23.81H114.1V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.38,0,.86.05.86.05v2.35h-.43c-2.55,0-4.84,1.64-4.84,5.12v4.09h5.27v2.25Z"/>
                <path d="M132.85,16.72a2.28,2.28,0,0,1-2.33-2.23v0a2.34,2.34,0,0,1,4.67,0,2.28,2.28,0,0,1-2.3,2.26h0M131,21.56h3.71V46.88H131Z"/>
                <path d="M150.53,47.49c-6,0-10.63-5.16-10.63-13.29S144.52,21,150.66,21a9.76,9.76,0,0,1,6.17,1.74l-1,2.25a7.53,7.53,0,0,0-4.4-1.36c-5.15,0-7.78,4.46-7.78,10.48,0,6.2,3,10.62,7.65,10.62a8,8,0,0,0,4.49-1.37l1,2.45a10.21,10.21,0,0,1-6.3,1.73"/>
                <path d="M162.84,35.75c.48,6,3.76,9,8.9,9a14.66,14.66,0,0,0,6.88-1.55l1.08,2.59a18,18,0,0,1-8.22,1.73c-7.12,0-12.18-4.23-12.18-13.34,0-8.69,4.67-13.2,11-13.2s10.37,3.95,10.37,12.4Zm7.35-12.41c-4.1,0-7.56,3.2-7.52,10.29l14.39-2c0-5.87-2.81-8.32-6.87-8.32"/>
                <path d="M198.57,23.81V46.88H194.9V23.81h-3.76V21.56h3.76V17.9c0-4.61,2.72-7.95,8.08-7.95.39,0,.87.05.87.05v2.35h-.44c-2.54,0-4.84,1.64-4.84,5.12v4.09h5.28v2.25Z"/>
                <path d="M217.28,47.49c-7.47,0-10.89-5.78-10.89-13.24S209.81,21,217.28,21s10.85,5.82,10.85,13.3-3.37,13.24-10.85,13.24m0-24c-5.53,0-7.13,5.59-7.13,10.81s1.73,10.56,7.13,10.56,7.13-5.35,7.13-10.56-1.6-10.81-7.13-10.81"/>
                <path d="M244.08,23.91c-2.34-.61-5.75-.52-7.35.47v22.5H233V22.69c2.67-1.13,5.36-1.74,10.11-1.74H245Z"/>
                <path d="M277.42,47.13,263.07,25a32.2,32.2,0,0,1-1.85-3.29h-.09s.13,1.88.13,3.85V47.13h-4.71V14.8h5.31l13.61,20.82A28.76,28.76,0,0,1,277.38,39h.08s-.17-1.84-.17-3.77V14.8H282V47.13Z"/>
                <path d="M297.52,47.79c-7.43,0-10.93-3-10.93-7.81,0-6.8,7.12-8.64,15.59-9.39V29.13c0-3.47-2.37-4.51-5.83-4.51a18,18,0,0,0-6.87,1.46L288.23,23a24,24,0,0,1,9.12-1.83c5.61,0,9.93,2.3,9.93,8.78V46a22.71,22.71,0,0,1-9.76,1.83m4.66-14.67c-6.26.67-10.45,1.84-10.45,6.73,0,3.42,2.42,4.88,6.22,4.88a10.09,10.09,0,0,0,4.23-.84Z"/>
                <path d="M322,47.69c-5.31,0-7.34-3.43-7.34-6.86V25.09h-3.55V21.81h3.55V16.12l5.4-1.5v7.19H325v3.28h-5V40.55a3.26,3.26,0,0,0,3,3.52h.5a5.5,5.5,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M331.91,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.44V47.13h-5.44Z"/>
                <path d="M350.88,47.79c-7.73,0-11.57-5.74-11.57-13.3s3.84-13.34,11.57-13.34,11.54,5.78,11.54,13.34-3.8,13.3-11.54,13.3m0-23.17c-4.66,0-6.05,4.89-6.05,9.82s1.47,9.63,6.05,9.63,6.05-4.7,6.05-9.63-1.38-9.82-6.05-9.82"/>
                <path d="M382.52,47.13V29c0-3.24-2.77-4.47-5.88-4.47a12.3,12.3,0,0,0-4.37.76v21.8h-5.39V23a26.81,26.81,0,0,1,10.06-1.83c6.61,0,11,2.25,11,7.8V47.13Z"/>
                <path d="M403.18,47.79c-7.43,0-10.94-3-10.94-7.81,0-6.8,7.13-8.64,15.6-9.39V29.13c0-3.47-2.37-4.51-5.83-4.51a18,18,0,0,0-6.87,1.46L393.89,23A24,24,0,0,1,403,21.15c5.62,0,9.94,2.3,9.94,8.78V46a22.71,22.71,0,0,1-9.76,1.83m4.66-14.67c-6.27.67-10.46,1.84-10.46,6.73,0,3.42,2.43,4.88,6.23,4.88a10.09,10.09,0,0,0,4.23-.84Z"/>
                <polygon points="418.52 47.13 418.52 34.91 418.52 10.25 423.92 10.25 423.92 22.76 423.92 47.13 418.52 47.13"/>
                <path d="M445.39,47.79A19.11,19.11,0,0,1,436.58,46l1.51-4a13.48,13.48,0,0,0,6.22,1.55c3.76,0,6.44-2.21,6.44-5.41,0-7.09-13.44-4.36-13.44-14.42,0-5.13,4.15-9.59,10.72-9.59A15.82,15.82,0,0,1,455.8,16l-1.38,3.52a11.93,11.93,0,0,0-5.66-1.5c-3.5,0-5.79,2.11-5.79,5.12,0,7,13.74,3.94,13.74,14.65,0,5.74-4.71,10-11.32,10"/>
                <path d="M470.41,47.69c-5.31,0-7.34-3.43-7.34-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.92v3.28h-4.92V40.55a3.27,3.27,0,0,0,3,3.52h.48a5.12,5.12,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M487.27,47.79c-7.44,0-10.93-3-10.93-7.81,0-6.8,7.13-8.64,15.6-9.39V29.13c0-3.47-2.38-4.51-5.84-4.51a18,18,0,0,0-6.87,1.46L478,23a23.94,23.94,0,0,1,9.11-1.83c5.62,0,9.94,2.3,9.94,8.78V46a22.71,22.71,0,0,1-9.76,1.83M492,33.16c-6.27.67-10.46,1.84-10.46,6.73,0,3.42,2.42,4.88,6.22,4.88a10,10,0,0,0,4.24-.84Z"/>
                <path d="M511.73,47.69c-5.32,0-7.35-3.43-7.35-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.92v3.28h-4.92V40.55a3.26,3.26,0,0,0,3,3.52h.5a5.5,5.5,0,0,0,1.46-.23v3.33a7.69,7.69,0,0,1-3,.52"/>
                <path d="M521.66,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.45V47.13h-5.45Z"/>
                <path d="M536.19,47.79A15.9,15.9,0,0,1,528.54,46L530,42.48a10.53,10.53,0,0,0,5.52,1.5c2.77,0,5-1.78,5-3.94,0-6-11.1-3.2-11.1-11.47,0-3.76,3.37-7.42,8.86-7.42A13.56,13.56,0,0,1,545.34,23l-1.42,3.14a8.47,8.47,0,0,0-4.62-1.45c-2.81,0-4.54,1.69-4.54,3.62,0,5.64,11.32,3.14,11.32,11.6,0,4-3.85,7.9-9.89,7.9"/>
                <path d="M559.83,47.69c-5.31,0-7.35-3.43-7.35-6.86V25.09h-3.54V21.81h3.54V16.12l5.4-1.5v7.19h4.93v3.28h-4.93V40.55a3.27,3.27,0,0,0,3,3.52h.48a5.64,5.64,0,0,0,1.47-.23v3.33a7.72,7.72,0,0,1-3,.52"/>
                <path d="M569.77,17.43a3,3,0,0,1-3.15-2.81,3.17,3.17,0,0,1,6.31,0,3,3,0,0,1-3.16,2.81m-2.72,4.38h5.44V47.13h-5.44Z"/>
                <path d="M588.14,47.79c-6.23,0-11-5.08-11-13.35s4.88-13.29,11-13.29A10.51,10.51,0,0,1,594.66,23l-1.21,3a6.87,6.87,0,0,0-4-1.22c-4.4,0-6.69,3.81-6.69,9.49s2.63,9.59,6.61,9.59a6.74,6.74,0,0,0,4-1.28L594.7,46c-1.12.94-3.33,1.84-6.56,1.84"/>
                <path d="M605.1,47.79A15.9,15.9,0,0,1,597.45,46l1.42-3.47A10.54,10.54,0,0,0,604.4,44c2.77,0,5-1.78,5-3.94,0-6-11.1-3.2-11.1-11.47,0-3.76,3.37-7.42,8.85-7.42a13.49,13.49,0,0,1,7.1,1.83l-1.42,3.14a8.42,8.42,0,0,0-4.63-1.45c-2.8,0-4.53,1.69-4.53,3.62,0,5.64,11.32,3.14,11.32,11.6,0,4-3.85,7.9-9.89,7.9"/>
            </g>
        </svg>
    

        
    
                            </div>
                        
                    </div>
                    
                </div>
                
                
            </div>
        </div>
    </footer>


                    
                
            </div>
            
        

        
            
        

        <script>
            (function() {
                var s = 'https://cdn.ons.gov.uk/sdc/design-system/62.0.0/scripts/main.js'.split(','),
                c = document.createElement('script');

                if (!('noModule' in c)) {
                    for (var i = 0; i < s.length; i++) {
                        s[i] = s[i].replace('.js', '.es5.js');
                    }
                }

                for (var i = 0; i < s.length; i++) {
                    var e = document.createElement('script');

                    e.src = s[i];

                    document.body.appendChild(e);
                }
            })();
        </script>

        
    </body>
</html>